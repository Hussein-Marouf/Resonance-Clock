<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Resonance Clock</title>

<!-- PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Resonance">
<meta name="theme-color" content="#0a0a12">
<meta name="mobile-web-app-capable" content="yes">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --bg: #0a0a12;
  --bg2: #0f0f1a;
  --bg3: #151525;
  --card: #12121f;
  --card2: #181830;
  --gold: #d4a84b;
  --gold-soft: #c8a04880;
  --gold-glow: rgba(212,168,75,0.12);
  --amber: #f0922a;
  --cyan: #3ec8c0;
  --rose: #e05a7a;
  --mint: #5cc4a0;
  --violet: #8b6fe0;
  --blue: #4a7fd4;
  --text: #eae6dc;
  --text2: #9a9488;
  --text3: #555048;
  --border: rgba(212,168,75,0.12);
  --radius: 20px;
  --radius-sm: 12px;
  --font: 'Outfit', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  height: 100%;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  touch-action: manipulation;
}

/* â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app {
  display: flex;
  flex-direction: column;
  height: 100%;
  max-width: 500px;
  margin: 0 auto;
  position: relative;
}

/* â”€â”€ STATUS BAR AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-area {
  padding: calc(var(--safe-top) + 8px) 24px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}
.status-greeting {
  font-size: 13px;
  font-weight: 300;
  color: var(--text2);
  letter-spacing: 0.02em;
}
.status-time {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--gold);
  font-weight: 400;
  letter-spacing: 0.06em;
}

/* â”€â”€ MAIN SCROLLABLE AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: 0 20px 120px;
  scroll-behavior: smooth;
}
.main::-webkit-scrollbar { display: none; }

/* â”€â”€ VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.view { display: none; }
.view.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* â”€â”€ CLOCK VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.clock-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 8px;
}
#app-clock {
  display: block;
  width: 100%;
  max-width: 340px;
  aspect-ratio: 1;
  touch-action: none;
}

/* â”€â”€ PHASE HERO CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.phase-hero {
  width: 100%;
  margin-top: 20px;
  padding: 24px;
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
  transition: all 0.5s ease;
}
.phase-hero::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.06);
  pointer-events: none;
}
.phase-hero-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.5);
  margin-bottom: 8px;
}
.phase-hero-name {
  font-size: 36px;
  font-weight: 200;
  letter-spacing: -0.02em;
  line-height: 1;
  margin-bottom: 4px;
}
.phase-hero-window {
  font-family: var(--mono);
  font-size: 13px;
  color: rgba(255,255,255,0.5);
  margin-bottom: 16px;
  font-weight: 300;
}
.phase-hero-bio {
  font-size: 14px;
  font-weight: 300;
  color: rgba(255,255,255,0.7);
  line-height: 1.65;
}

/* Progress ring */
.phase-progress {
  margin-top: 18px;
  height: 4px;
  background: rgba(255,255,255,0.08);
  border-radius: 2px;
  overflow: hidden;
}
.phase-progress-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 1s linear;
}

/* â”€â”€ ACTION TIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tip-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 20px;
}
.tip-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  transition: transform 0.15s, background 0.15s;
}
.tip-card:active { transform: scale(0.97); background: var(--card2); }
.tip-icon {
  font-size: 22px;
  margin-bottom: 8px;
  display: block;
}
.tip-title {
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 4px;
  letter-spacing: 0.01em;
}
.tip-sub {
  font-size: 11px;
  color: var(--text2);
  font-weight: 300;
  line-height: 1.5;
}

/* â”€â”€ TIMELINE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline-header {
  font-size: 26px;
  font-weight: 200;
  letter-spacing: -0.02em;
  margin-bottom: 24px;
  padding-top: 8px;
}
.timeline-header em { color: var(--gold); font-style: normal; }

.tl-phase {
  display: flex;
  gap: 16px;
  padding: 18px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transition: opacity 0.3s;
  cursor: pointer;
}
.tl-phase:active { opacity: 0.7; }
.tl-phase.is-current { background: var(--gold-glow); margin: 0 -20px; padding: 18px 20px; border-radius: var(--radius-sm); border-bottom: none; }

.tl-time-col {
  flex-shrink: 0;
  width: 52px;
  text-align: right;
}
.tl-time {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 400;
  color: var(--text2);
}
.tl-dur {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  margin-top: 2px;
}
.tl-indicator {
  width: 3px;
  flex-shrink: 0;
  border-radius: 3px;
  align-self: stretch;
  min-height: 40px;
}
.tl-content { flex: 1; min-width: 0; }
.tl-name {
  font-size: 17px;
  font-weight: 400;
  letter-spacing: -0.01em;
  margin-bottom: 3px;
}
.tl-bio {
  font-size: 12px;
  color: var(--text2);
  font-weight: 300;
  line-height: 1.6;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.tl-phase.is-current .tl-time { color: var(--gold); }
.tl-phase.is-current .tl-name { color: var(--gold); }
.tl-now-badge {
  display: inline-block;
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  padding: 2px 8px;
  background: var(--gold);
  color: var(--bg);
  border-radius: 4px;
  margin-left: 8px;
  vertical-align: middle;
  font-weight: 500;
}

/* â”€â”€ INSIGHTS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.insights-header {
  font-size: 26px;
  font-weight: 200;
  letter-spacing: -0.02em;
  margin-bottom: 24px;
  padding-top: 8px;
}
.insight-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 16px;
}
.insight-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 12px;
}
.insight-big {
  font-size: 42px;
  font-weight: 200;
  letter-spacing: -0.03em;
  line-height: 1;
  margin-bottom: 6px;
}
.insight-sub {
  font-size: 13px;
  color: var(--text2);
  font-weight: 300;
  line-height: 1.5;
}
.insight-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}
.insight-mini {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 18px;
  text-align: center;
}
.insight-mini-val {
  font-family: var(--mono);
  font-size: 24px;
  font-weight: 300;
  margin-bottom: 4px;
}
.insight-mini-lbl {
  font-size: 11px;
  color: var(--text3);
  font-weight: 300;
}

#insight-chart { display: block; width: 100%; }

/* â”€â”€ SETTINGS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-header {
  font-size: 26px;
  font-weight: 200;
  letter-spacing: -0.02em;
  margin-bottom: 24px;
  padding-top: 8px;
}
.setting-group {
  margin-bottom: 28px;
}
.setting-group-title {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 14px;
}
.setting-item {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 18px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.setting-item:first-of-type { border-radius: var(--radius-sm) var(--radius-sm) 0 0; }
.setting-item:last-of-type { border-radius: 0 0 var(--radius-sm) var(--radius-sm); }
.setting-item:only-of-type { border-radius: var(--radius-sm); }
.setting-item + .setting-item { border-top: none; }
.setting-label { font-size: 15px; font-weight: 400; }
.setting-val {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--gold);
  font-weight: 400;
}

.chrono-setting {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 20px;
}
.chrono-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}
.chrono-type-label {
  font-size: 15px;
  font-weight: 400;
}
.chrono-type-val {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--gold);
}
input[type=range].app-slider {
  -webkit-appearance: none;
  width: 100%;
  height: 4px;
  background: linear-gradient(90deg, var(--cyan), var(--gold), var(--rose));
  outline: none;
  border-radius: 2px;
}
input[type=range].app-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 24px;
  height: 24px;
  background: var(--bg);
  border: 3px solid var(--gold);
  border-radius: 50%;
  box-shadow: 0 0 12px rgba(212,168,75,0.3);
}
.chrono-endpoints {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
  font-size: 11px;
  color: var(--text3);
  font-weight: 300;
}

.about-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 20px;
  margin-top: 12px;
}
.about-card p {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.7;
  font-weight: 300;
}
.about-card p + p { margin-top: 10px; }
.about-card strong { color: var(--text); font-weight: 500; }
.about-link {
  color: var(--gold);
  text-decoration: none;
  font-weight: 400;
}

/* â”€â”€ BOTTOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 500px;
  display: flex;
  justify-content: space-around;
  padding: 8px 12px calc(var(--safe-bottom) + 8px);
  background: linear-gradient(to top, var(--bg) 70%, transparent);
  z-index: 100;
}
.nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 16px;
  background: none;
  border: none;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: transform 0.12s;
}
.nav-btn:active { transform: scale(0.92); }
.nav-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.nav-icon svg {
  width: 22px;
  height: 22px;
  stroke: var(--text3);
  stroke-width: 1.5;
  fill: none;
  transition: stroke 0.2s;
}
.nav-label {
  font-size: 10px;
  font-weight: 400;
  color: var(--text3);
  letter-spacing: 0.04em;
  transition: color 0.2s;
}
.nav-btn.active .nav-icon svg { stroke: var(--gold); }
.nav-btn.active .nav-label { color: var(--gold); }

/* â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (min-width: 500px) {
  .app { border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
}
</style>
</head>

<body>
<div class="app">

  <div class="status-area">
    <div class="status-greeting" id="greeting">Good evening</div>
    <div class="status-time" id="top-time">--:--</div>
  </div>

  <div class="main">

    <!-- CLOCK VIEW -->
    <div class="view active" id="view-clock">
      <div class="clock-wrap">
        <canvas id="app-clock"></canvas>
      </div>

      <div class="phase-hero" id="phase-hero">
        <div class="phase-hero-label" id="ph-label">Phase 1 of 9</div>
        <div class="phase-hero-name" id="ph-name">Rest</div>
        <div class="phase-hero-window" id="ph-window">00:00 â†’ 06:57</div>
        <div class="phase-hero-bio" id="ph-bio">Loading...</div>
        <div class="phase-progress">
          <div class="phase-progress-fill" id="ph-progress" style="width:0%"></div>
        </div>
      </div>

      <div class="tip-cards" id="tip-cards"></div>
    </div>

    <!-- TIMELINE VIEW -->
    <div class="view" id="view-timeline">
      <div class="timeline-header">Your <em>Daily Rhythm</em></div>
      <div id="timeline-list"></div>
    </div>

    <!-- INSIGHTS VIEW -->
    <div class="view" id="view-insights">
      <div class="insights-header">Rhythm Insights</div>
      <div class="insight-row">
        <div class="insight-mini">
          <div class="insight-mini-val" style="color:var(--mint)" id="ins-mae">â€”</div>
          <div class="insight-mini-lbl">Model Accuracy (MAE)</div>
        </div>
        <div class="insight-mini">
          <div class="insight-mini-val" style="color:var(--cyan)" id="ins-r2">â€”</div>
          <div class="insight-mini-lbl">Correlation (RÂ²)</div>
        </div>
      </div>
      <div class="insight-card">
        <div class="insight-label">Hormone Composite</div>
        <canvas id="insight-chart" height="180"></canvas>
      </div>
      <div class="insight-card">
        <div class="insight-label">How this works</div>
        <div class="insight-sub" style="line-height:1.7">
          Phase boundaries are computed from a multi-marker composite of <strong style="color:var(--text)">cortisol</strong> (4 harmonics, peak 07:30),
          <strong style="color:var(--text)">core temperature</strong> (3 harmonics, peak 17:00), and
          <strong style="color:var(--text)">melatonin</strong> (3 harmonics, peak 03:00).
          Structural points â€” extrema and inflections of F(t) = 0.5Â·C + 0.3Â·T + 0.2Â·M â€” define the 9 phase transitions.
          Parameters from Brabant 1990, Van Cauter 1999, Refinetti 2010, Lewy 1999.
        </div>
      </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div class="view" id="view-settings">
      <div class="settings-header">Settings</div>

      <div class="setting-group">
        <div class="setting-group-title">Chronotype</div>
        <div class="chrono-setting">
          <div class="chrono-row">
            <div class="chrono-type-label">Chronotype Offset</div>
            <div class="chrono-type-val" id="set-chrono-val">+0.0 h</div>
          </div>
          <input type="range" class="app-slider" id="set-chrono" min="0" max="30" value="0" step="1">
          <div class="chrono-endpoints">
            <span>Early Bird</span><span>Intermediate</span><span>Night Owl</span>
          </div>
        </div>
      </div>

      <div class="setting-group">
        <div class="setting-group-title">About</div>
        <div class="about-card">
          <p><strong>The 9-Phase Resonance Clock</strong> maps your circadian biology into 9 actionable phases derived from published biochemical data â€” not arbitrary time blocks.</p>
          <p>Based on the research of H.A. Marouf. Phase boundaries emerge from the mathematical structure of hormonal oscillations.</p>
          <p style="font-family:var(--mono);font-size:11px;color:var(--text3);margin-top:12px;">Abacus Omega Inc. Â· v2.0</p>
        </div>
      </div>
    </div>

  </div><!-- main -->

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('clock')">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
      <div class="nav-label">Clock</div>
    </button>
    <button class="nav-btn" onclick="switchView('timeline')">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="14" y2="18"/></svg></div>
      <div class="nav-label">Schedule</div>
    </button>
    <button class="nav-btn" onclick="switchView('insights')">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
      <div class="nav-label">Insights</div>
    </button>
    <button class="nav-btn" onclick="switchView('settings')">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
      <div class="nav-label">Settings</div>
    </button>
  </div>

</div><!-- app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPUTATION ENGINE (same corrected model)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TAU = 24;
function arrMin(a){let m=a[0];for(let i=1;i<a.length;i++)if(a[i]<m)m=a[i];return m;}
function arrMax(a){let m=a[0];for(let i=1;i<a.length;i++)if(a[i]>m)m=a[i];return m;}
function makeOsc(pk,amps){return t=>{let v=0;for(let n=1;n<=amps.length;n++)v+=amps[n-1]*Math.cos(n*2*Math.PI*t/TAU-2*Math.PI*n*pk/TAU);return v;};}
function norm(fn){const v=Array.from({length:1000},(_,i)=>fn(i*TAU/1000));const mn=arrMin(v),mx=arrMax(v),r=mx-mn||1;return t=>(fn(t)-mn)/r*2-1;}

const cN=norm(makeOsc(7.5,[1,.38,.18,.08]));
const tN=norm(makeOsc(17.0,[1,.22,.08]));
const mN=norm(makeOsc(3.0,[1,.35,.12]));
const F=t=>0.5*cN(t)+0.3*tN(t)+0.2*mN(t);

const DT=1e-4;
const d1=(fn,t)=>(fn(t+DT)-fn(t-DT))/(2*DT);
const d2=(fn,t)=>(fn(t+DT)-2*fn(t)+fn(t-DT))/(DT*DT);

function findZeros(fn){
  const N=50000,dt=TAU/N,z=[];let p=fn(0);
  for(let i=1;i<=N;i++){const t=i*dt,c=fn(t);if(p*c<0){let lo=(i-1)*dt,hi=t;for(let k=0;k<30;k++){const mid=(lo+hi)/2;if(fn(lo)*fn(mid)<=0)hi=mid;else lo=mid;}z.push((lo+hi)/2);}p=c;}return z;
}

function computePhases(){
  const ext=findZeros(t=>d1(F,t));
  const inf=findZeros(t=>d2(F,t));
  const all=[...ext,...inf].sort((a,b)=>a-b);
  let th=0.5,merged;
  while(th>=0.1){merged=[];for(const t of all){if(!merged.length||t-merged[merged.length-1]>th)merged.push(t);}if(merged.length>=9)break;th-=0.1;}
  const scored=merged.map(t=>({t,score:Math.abs(d1(F,t))+0.5*Math.abs(F(t))}));
  scored.sort((a,b)=>b.score-a.score);
  const top9=scored.slice(0,9).map(x=>x.t).sort((a,b)=>a-b);
  const vals=top9.map(t=>F(t));
  const mi=vals.indexOf(Math.min(...vals));
  const rot=[...top9.slice(mi),...top9.slice(0,mi)];
  const off=rot[0];
  return rot.map(t=>(t-off+TAU)%TAU);
}

const MODEL_TIMES=computePhases();
const MODEL_ANGLES=MODEL_TIMES.map(t=>(t/TAU)*360);
const ARTWORK=[0,40.1,82,128.3,171.1,196.2,237.2,270,317.6];
const MAE=(MODEL_ANGLES.reduce((s,v,i)=>s+Math.abs(v-ARTWORK[i]),0)/9);
const aMean=ARTWORK.reduce((a,b)=>a+b,0)/9;
const ssRes=MODEL_ANGLES.reduce((s,m,i)=>s+Math.pow(ARTWORK[i]-m,2),0);
const ssTot=ARTWORK.reduce((s,a)=>s+Math.pow(a-aMean,2),0);
const R2=(1-ssRes/ssTot);

const PHASE_COLORS=['#4a6fa5','#6b9fd4','#f0922a','#e8d060','#e05a7a','#8b6fe0','#3ec8c0','#5cc4a0','#a89fd4'];
const PHASES=[
  {name:"Rest",icon:"ğŸŒ™",tips:[{icon:"ğŸ˜´",t:"Sleep deeply",s:"Body repair and memory consolidation active"},{icon:"ğŸ“µ",t:"Screens off",s:"Melatonin at peak â€” protect it"}]},
  {name:"Preparation",icon:"ğŸŒ…",tips:[{icon:"ğŸ’§",t:"Hydrate first",s:"Cortisol awakening response starting"},{icon:"ğŸ§˜",t:"Gentle movement",s:"Ease into the day as HPA axis activates"}]},
  {name:"Energy Rise",icon:"âš¡",tips:[{icon:"â˜€ï¸",t:"Get sunlight",s:"Light exposure suppresses residual melatonin"},{icon:"ğŸ³",t:"Protein breakfast",s:"Fuel the metabolic acceleration"}]},
  {name:"Focus",icon:"ğŸ¯",tips:[{icon:"ğŸ§ ",t:"Deep work now",s:"Cortisol + testosterone at daily peak"},{icon:"ğŸš«",t:"Block distractions",s:"Working memory at maximum capacity"}]},
  {name:"Peak",icon:"ğŸ’ª",tips:[{icon:"ğŸƒ",t:"Physical peak",s:"Reaction time and strength at best"},{icon:"ğŸ“‹",t:"Handle challenges",s:"Cardiovascular output at daily max"}]},
  {name:"Reflection",icon:"ğŸƒ",tips:[{icon:"ğŸš¶",t:"Take a walk",s:"Post-lunch alertness dip is natural"},{icon:"ğŸ“–",t:"Creative thinking",s:"Relaxed state aids divergent thought"}]},
  {name:"Renewal",icon:"ğŸ”¥",tips:[{icon:"ğŸ‹ï¸",t:"Train now",s:"Core temp at peak â€” optimal for exercise"},{icon:"ğŸ“Š",t:"Review & plan",s:"Second alertness wave supports review"}]},
  {name:"Transition",icon:"ğŸŒ†",tips:[{icon:"ğŸ“´",t:"Dim the lights",s:"Melatonin onset beginning â€” protect it"},{icon:"ğŸµ",t:"Wind down",s:"Switch from output to recovery mode"}]},
  {name:"Closure",icon:"ğŸŒŒ",tips:[{icon:"ğŸ“",t:"Journal",s:"Process the day before sleep"},{icon:"ğŸ›ï¸",t:"Sleep prep",s:"Sleep pressure at threshold â€” listen to it"}]},
];

// State
let chronoOffset = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  event.currentTarget.classList.add('active');
  if(name==='timeline') buildTimeline();
  if(name==='insights') drawInsightChart();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const clockEl = document.getElementById('app-clock');
const clockCtx = clockEl.getContext('2d');

function drawAppClock(){
  const dpr = window.devicePixelRatio || 1;
  const size = clockEl.parentElement.offsetWidth;
  const displaySize = Math.min(size, 340);
  clockEl.style.width = displaySize+'px';
  clockEl.style.height = displaySize+'px';
  clockEl.width = displaySize * dpr;
  clockEl.height = displaySize * dpr;
  const ctx = clockCtx;
  ctx.scale(dpr, dpr);

  const W=displaySize, H=displaySize;
  const cx=W/2, cy=H/2, R=W/2-28;

  ctx.clearRect(0,0,W,H);

  const now=new Date();
  const sec=now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
  const shifted=(sec-chronoOffset*3600+86400)%86400;
  const curDeg=(shifted/86400)*360;
  const curRad=(curDeg-90)*Math.PI/180;

  const times=MODEL_TIMES.map(t=>(t+chronoOffset)%TAU);
  function tRad(h){return(h/TAU)*Math.PI*2-Math.PI/2;}
  let curPhase=0;

  // Phase arcs
  for(let i=0;i<9;i++){
    const sT=times[i], eT=times[(i+1)%9];
    const sR=tRad(sT);
    let eR=tRad(eT);
    if(eR<=sR) eR+=Math.PI*2;

    const sDeg=(sT/TAU)*360, eDeg=(eT/TAU)*360;
    const inP = eT>sT ? (curDeg>=sDeg&&curDeg<eDeg) : (curDeg>=sDeg||curDeg<eDeg);
    if(inP) curPhase=i;

    const a = inP ? 0.28 : 0.08;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,sR,eR); ctx.closePath();
    ctx.fillStyle=PHASE_COLORS[i]+Math.round(a*255).toString(16).padStart(2,'0'); ctx.fill();

    ctx.beginPath(); ctx.arc(cx,cy,R,sR,eR);
    ctx.strokeStyle=PHASE_COLORS[i]+(inP?'cc':'44'); ctx.lineWidth=inP?3.5:1.5; ctx.stroke();

    // Phase icon
    const mid=(sR+eR)/2;
    const ir=R-18;
    ctx.font=(inP?'14px':'11px')+' sans-serif';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#fff';
    ctx.fillText(PHASES[i].icon, cx+ir*Math.cos(mid), cy+ir*Math.sin(mid));

    // Boundary tick
    ctx.beginPath();
    ctx.moveTo(cx+(R-6)*Math.cos(sR), cy+(R-6)*Math.sin(sR));
    ctx.lineTo(cx+(R+4)*Math.cos(sR), cy+(R+4)*Math.sin(sR));
    ctx.strokeStyle='rgba(212,168,75,0.3)'; ctx.lineWidth=1; ctx.stroke();
  }

  // Hour ring
  for(let h=0;h<24;h++){
    const r=(h/24*360-90)*Math.PI/180;
    const r1=R+8, r2=R+(h%6===0?18:h%3===0?13:10);
    ctx.beginPath(); ctx.moveTo(cx+r1*Math.cos(r),cy+r1*Math.sin(r));
    ctx.lineTo(cx+r2*Math.cos(r),cy+r2*Math.sin(r));
    ctx.strokeStyle=h%6===0?'rgba(212,168,75,0.6)':'rgba(212,168,75,0.15)';
    ctx.lineWidth=h%6===0?1.5:0.8; ctx.stroke();
    if(h%6===0){
      const tr=R+24;
      ctx.fillStyle='rgba(212,168,75,0.55)'; ctx.font="500 9px 'JetBrains Mono'";
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(h.toString().padStart(2,'0'), cx+tr*Math.cos(r), cy+tr*Math.sin(r));
    }
  }

  // Inner ring
  ctx.beginPath(); ctx.arc(cx,cy,R*0.38,0,Math.PI*2);
  ctx.strokeStyle='rgba(212,168,75,0.06)'; ctx.lineWidth=1; ctx.stroke();

  // Hand
  ctx.beginPath(); ctx.moveTo(cx,cy);
  ctx.lineTo(cx+(R-8)*Math.cos(curRad), cy+(R-8)*Math.sin(curRad));
  ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.lineWidth=1.5; ctx.stroke();

  // Glow tip
  const hx=cx+(R-8)*Math.cos(curRad), hy=cy+(R-8)*Math.sin(curRad);
  const g=ctx.createRadialGradient(hx,hy,0,hx,hy,6);
  g.addColorStop(0,'rgba(255,255,255,0.8)'); g.addColorStop(1,'transparent');
  ctx.beginPath(); ctx.arc(hx,hy,6,0,Math.PI*2); ctx.fillStyle=g; ctx.fill();

  // Center
  ctx.beginPath(); ctx.arc(cx,cy,4,0,Math.PI*2);
  ctx.fillStyle=PHASE_COLORS[curPhase]; ctx.fill();

  // Time
  const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.font="500 16px 'JetBrains Mono'";
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(ts,cx,cy+32);

  updatePhaseHero(curPhase, times, curDeg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHASE HERO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePhaseHero(idx, times, curDeg){
  const sT=times[idx], eT=times[(idx+1)%9];
  const fmt=h=>{h=(h+24)%24;return Math.floor(h).toString().padStart(2,'0')+':'+Math.round((h%1)*60).toString().padStart(2,'0');};

  document.getElementById('ph-label').textContent=`Phase ${idx+1} of 9`;
  document.getElementById('ph-name').textContent=PHASES[idx].name;
  document.getElementById('ph-window').textContent=fmt(sT)+' â†’ '+fmt(eT);
  document.getElementById('ph-bio').textContent=PHASES[idx===0?0:idx].name==='Rest'?
    'Deep NREM sleep. Growth hormone pulse. Cellular repair and memory consolidation.':
    getPhaseBio(idx);

  const hero=document.getElementById('phase-hero');
  const col=PHASE_COLORS[idx];
  hero.style.background=`linear-gradient(135deg, ${col}18 0%, ${col}08 100%)`;
  document.getElementById('ph-name').style.color=col;
  document.getElementById('ph-progress').style.background=col;

  // Progress
  const sDeg=(sT/TAU)*360;
  let eDeg=(eT/TAU)*360;
  if(eDeg<=sDeg) eDeg+=360;
  let cur=curDeg; if(cur<sDeg) cur+=360;
  const pct=Math.min(100,Math.max(0,((cur-sDeg)/(eDeg-sDeg))*100));
  document.getElementById('ph-progress').style.width=pct+'%';

  // Tips
  const tips=PHASES[idx].tips;
  document.getElementById('tip-cards').innerHTML=tips.map(t=>`
    <div class="tip-card">
      <span class="tip-icon">${t.icon}</span>
      <div class="tip-title">${t.t}</div>
      <div class="tip-sub">${t.s}</div>
    </div>
  `).join('');

  // Top time
  const now=new Date();
  document.getElementById('top-time').textContent=
    now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');

  // Greeting
  const h=now.getHours();
  document.getElementById('greeting').textContent=
    h<5?'Good night':h<12?'Good morning':h<17?'Good afternoon':'Good evening';
}

function getPhaseBio(i){
  const bios=[
    'Deep NREM sleep. Growth hormone pulse. Cellular repair and memory consolidation. Melatonin at peak.',
    'Cortisol awakening response activating. Core temperature lifting from overnight minimum. Body preparing for the day.',
    'Rapid cortisol surge to daily peak. Melatonin suppressed. Metabolic rate accelerating. Full transition to waking state.',
    'Executive function at circadian peak. Working memory and analytical performance at daily maximum. Ideal for demanding cognitive work.',
    'Physical performance approaching apex. Reaction time, strength, and cardiovascular output near daily maximum.',
    'Natural post-lunch alertness dip. Brief reduction in vigilance is normal. Good window for creative and divergent thinking.',
    'Core temperature at daily peak. Second alertness wave. Cardiovascular efficiency optimal. Best window for exercise.',
    'Melatonin onset beginning. Cortisol in steep decline. Body shifting from output mode to recovery mode.',
    'Melatonin rising to nocturnal plateau. Sleep pressure at threshold. Body preparing for deep rest cycle.'
  ];
  return bios[i]||'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTimeline(){
  const times=MODEL_TIMES.map(t=>(t+chronoOffset)%TAU);
  const now=new Date();
  const sec=now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
  const shifted=(sec-chronoOffset*3600+86400)%86400;
  const curDeg=(shifted/86400)*360;
  const fmt=h=>{h=(h+24)%24;return Math.floor(h).toString().padStart(2,'0')+':'+Math.round((h%1)*60).toString().padStart(2,'0');};

  let html='';
  for(let i=0;i<9;i++){
    const sT=times[i], eT=times[(i+1)%9];
    const sDeg=(sT/TAU)*360, eDeg=(eT/TAU)*360;
    const inP = eT>sT ? (curDeg>=sDeg&&curDeg<eDeg) : (curDeg>=sDeg||curDeg<eDeg);
    const dur = eT>sT ? eT-sT : (24-sT+eT);
    const durStr = dur>=1 ? Math.floor(dur)+'h '+Math.round((dur%1)*60)+'m' : Math.round(dur*60)+'m';

    html+=`
      <div class="tl-phase ${inP?'is-current':''}">
        <div class="tl-time-col">
          <div class="tl-time">${fmt(sT)}</div>
          <div class="tl-dur">${durStr}</div>
        </div>
        <div class="tl-indicator" style="background:${PHASE_COLORS[i]}"></div>
        <div class="tl-content">
          <div class="tl-name" style="color:${inP?'var(--gold)':'var(--text)'}">
            ${PHASES[i].icon} ${PHASES[i].name}${inP?'<span class="tl-now-badge">NOW</span>':''}
          </div>
          <div class="tl-bio">${getPhaseBio(i)}</div>
        </div>
      </div>
    `;
  }
  document.getElementById('timeline-list').innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INSIGHT CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawInsightChart(){
  document.getElementById('ins-mae').textContent=MAE.toFixed(1)+'Â°';
  document.getElementById('ins-r2').textContent=R2.toFixed(3);

  const canvas=document.getElementById('insight-chart');
  const dpr=window.devicePixelRatio||1;
  const W=canvas.parentElement.offsetWidth-48;
  canvas.style.width=W+'px'; canvas.style.height='180px';
  canvas.width=W*dpr; canvas.height=180*dpr;
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const H=180;
  const pad={l:8,r:8,t:12,b:24};
  const cW=W-pad.l-pad.r, cH=H-pad.t-pad.b;

  ctx.clearRect(0,0,W,H);

  const toX=t=>pad.l+(t/TAU)*cW;
  const toY=v=>pad.t+(1-(v+1)/2)*cH;

  // Zero line
  ctx.beginPath(); ctx.moveTo(pad.l,toY(0)); ctx.lineTo(pad.l+cW,toY(0));
  ctx.strokeStyle='rgba(212,168,75,0.15)'; ctx.lineWidth=1; ctx.stroke();

  // Phase boundaries
  MODEL_TIMES.forEach(t=>{
    const x=toX((t+chronoOffset)%TAU);
    ctx.beginPath(); ctx.moveTo(x,pad.t); ctx.lineTo(x,pad.t+cH);
    ctx.strokeStyle='rgba(212,168,75,0.2)'; ctx.lineWidth=1; ctx.setLineDash([2,3]); ctx.stroke(); ctx.setLineDash([]);
  });

  // Curves
  const N=400;
  [[cN,'#f0922a',0.5,1],[tN,'#3ec8c0',0.5,1],[mN,'#8b6fe0',0.5,1],[F,'#d4a84b',1,2.5]].forEach(([fn,col,a,w])=>{
    ctx.beginPath();
    for(let i=0;i<=N;i++){const t=i*TAU/N;const x=toX(t),y=toY(fn(t));i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
    ctx.strokeStyle=col; ctx.globalAlpha=a; ctx.lineWidth=w; ctx.stroke(); ctx.globalAlpha=1;
  });

  // Hour labels
  [0,6,12,18,24].forEach(h=>{
    ctx.fillStyle='rgba(212,168,75,0.35)'; ctx.font="9px 'JetBrains Mono'"; ctx.textAlign='center';
    ctx.fillText(h%24+'h', toX(h%24===0&&h===24?24:h), H-4);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHRONO SLIDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('set-chrono').addEventListener('input',function(){
  chronoOffset=parseInt(this.value)/10;
  const label=chronoOffset<0.8?'Early Bird':chronoOffset<2.2?'Intermediate':'Night Owl';
  document.getElementById('set-chrono-val').textContent=`+${chronoOffset.toFixed(1)} h Â· ${label}`;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tick(){
  drawAppClock();
  requestAnimationFrame(tick);
}

window.addEventListener('load',()=>{
  tick();
  buildTimeline();
  setInterval(buildTimeline, 60000);
});
window.addEventListener('resize',()=>drawAppClock());
</script>
</body>
</html>
