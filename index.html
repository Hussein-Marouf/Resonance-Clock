<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marouf Resonance Clock</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html, body {
  width:100%; height:100%;
  background:#030c05;
  font-family:'Source Sans 3',sans-serif;
  color:#d0c8a8;
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ── CANVAS ── */
#c {
  position:fixed; inset:0;
  width:100%; height:100%;
  display:block; z-index:0;
}

/* ── FULL-SCREEN LAYOUT ── */
#shell {
  position:fixed; inset:0; z-index:10;
  display:grid;
  grid-template-columns: 175px 1fr 175px;
  grid-template-rows: 56px 1fr auto;
  pointer-events:none;
}

/* ── HEADER ── */
#hdr {
  grid-column: 1 / -1; grid-row: 1;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 24px;
  border-bottom:1px solid rgba(160,185,150,0.18);
  background:rgba(3,12,5,0.80);
  backdrop-filter:blur(8px);
  pointer-events:all;
}
.hdr-title {
  font-family:'Source Sans 3',sans-serif; font-weight:600;
  font-size:15px; letter-spacing:0.14em;
  color:rgba(228,205,140,1.0);
}

#hdr-clock {
  font-family:'Source Sans 3',sans-serif;
  font-size:22px; letter-spacing:0.08em;
  color:rgba(215,195,130,1.0);
}
#hdr-date {
  font-size:10px; font-family:'Source Sans 3',sans-serif; font-weight:400; color:rgba(188,215,188,0.80); margin-top:2px; text-align:right;
}

/* ── LEFT SIDEBAR — Phase List ── */
#sidebar-left {
  grid-column:1; grid-row:2;
  padding:14px 0 14px 14px;
  display:flex; flex-direction:column; gap:2px;
  overflow-y:auto; pointer-events:all;
}
.sidebar-label {
  font-size:9px; letter-spacing:0.20em; text-transform:uppercase;
  color:rgba(170,200,178,0.85); margin-bottom:8px; padding-left:4px;
}

.ph-btn {
  display:flex; align-items:center; gap:10px;
  padding:8px 10px; border:1px solid transparent;
  border-radius:4px; background:transparent;
  cursor:pointer; text-align:left;
  transition:all 0.22s ease; color:inherit; width:100%;
}
.ph-btn:hover {
  background:rgba(255,255,255,0.05);
  border-color:rgba(168,200,158,0.30);
}
.ph-btn.active {
  background:rgba(255,255,255,0.06);
  border-color:rgba(190,160,65,0.40);
}
.ph-pip {
  width:9px; height:9px; border-radius:50%; flex-shrink:0;
  transition:transform 0.35s, box-shadow 0.35s;
}
.ph-btn.active .ph-pip { transform:scale(1.6); }
.ph-info { flex:1; min-width:0; }
.ph-name {
  font-family:'Source Sans 3',sans-serif; font-weight:500; font-size:12.5px; color:rgba(200,225,205,0.92);
  display:block; line-height:1.25;
  transition:color 0.22s;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.ph-btn.active .ph-name { color:rgba(235,218,165,1.0); }
.ph-time {
  font-size:10px; letter-spacing:0.05em;
  color:rgba(168,195,175,0.75); display:block;
  transition:color 0.22s;
}
.ph-btn.active .ph-time { color:rgba(215,185,100,0.85); }

/* ── TAGLINE ── */
#tagline {
  position:fixed; transform:translateX(-50%);
  z-index:15; pointer-events:none;
  display:flex; align-items:center; gap:14px;
  white-space:nowrap;
}
#tagline::before,
#tagline::after {
  content:''; display:block;
  width:40px; height:1px; flex-shrink:0;
  background:linear-gradient(90deg, transparent, rgba(228,205,100,0.45), transparent);
}
#tagline-text {
  font-family:'Source Sans 3',sans-serif;
  font-size:14px; font-weight:500; letter-spacing:0.12em;
  color:rgba(245,225,100,0.95);
  text-shadow:0 0 20px rgba(228,200,80,0.35), 0 0 50px rgba(200,175,60,0.15);
}
/* ═══ MOBILE OVERHAUL ═══ */
@media(max-width:900px){
  /* Tagline */
  #tagline { gap:10px; }
  #tagline::before, #tagline::after { width:24px; }
  #tagline-text { font-size:12px; letter-spacing:0.08em; }
}
@media(max-width:500px){
  #tagline { white-space:normal; }
  #tagline::before, #tagline::after { display:none; }
  #tagline-text { font-size:11px; letter-spacing:0.05em; text-align:center; line-height:1.5; }
}

/* ── CENTER — text positioned BELOW the clock face ── */
#center-area {
  grid-column:2; grid-row:2;
  display:flex; align-items:flex-end; justify-content:center;
  padding-bottom:18px;
  pointer-events:none;
}
#center-text { text-align:center; width:280px; }
#ct-num {
  font-size:11px; letter-spacing:0.22em;
  color:rgba(188,225,198,0.90); display:block; margin-bottom:6px;
}
#ct-name {
  font-family:'Source Sans 3',sans-serif; font-weight:600;
  font-size:clamp(22px,5vw,40px); display:block; line-height:1;
  margin-bottom:6px; transition:opacity 0.5s, color 0.8s;
}
#ct-range {
  display:block; font-size:13px; letter-spacing:0.10em;
  color:rgba(215,228,218,0.90); margin-top:6px;
  font-family:'Source Sans 3',sans-serif;
}
#ct-until {
  display:block; font-size:11px; letter-spacing:0.12em;
  color:rgba(188,218,195,0.80); margin-top:4px;
}

/* ── RIGHT SIDEBAR ── */
#sidebar-right {
  grid-column:3; grid-row:2;
  padding:14px 14px 14px 0;
  display:flex; flex-direction:column; gap:14px;
  pointer-events:all;
}
.sr-label {
  font-size:9px; letter-spacing:0.20em; text-transform:uppercase;
  color:rgba(175,208,182,0.85); margin-bottom:5px;
}
#bio-card {
  flex:1; background:rgba(5,14,7,0.55);
  border:1px solid rgba(148,180,155,0.25); border-radius:4px;
  padding:12px;
}
#bio-text {
  font-family:'Source Sans 3',sans-serif; font-size:13px; line-height:1.75;
  color:rgba(192,220,198,0.88); transition:opacity 0.5s;
}

/* Science stats */
.stat-row { display:flex; flex-direction:column; gap:5px; }
.stat-item {
  display:flex; align-items:baseline; justify-content:space-between; gap:8px;
  padding:6px 10px; background:rgba(5,14,7,0.50);
  border:1px solid rgba(148,178,152,0.22); border-radius:3px;
}
.stat-val {
  font-family:'Source Sans 3',sans-serif; font-weight:600;
  font-size:18px; line-height:1;
}
.stat-lbl {
  font-size:9px; letter-spacing:0.06em;
  color:rgba(175,205,182,0.88); text-align:right; line-height:1.4;
}

/* ── BOTTOM PANEL ── */
#bottom-panel {
  grid-column: 1 / -1; grid-row: 3;
  background:rgba(3,10,4,0.92);
  border-top:1px solid rgba(160,185,150,0.22);
  backdrop-filter:blur(10px);
  pointer-events:all;
}

/* Tab bar */
#tab-bar {
  display:flex; gap:0;
  border-bottom:1px solid rgba(130,158,130,0.10);
  padding:0 20px;
}
.tb {
  font-family:'Source Sans 3',sans-serif;
  font-size:10px; letter-spacing:0.16em; text-transform:uppercase;
  padding:10px 16px 9px; border:none;
  border-bottom:2px solid transparent;
  background:none; color:rgba(178,212,188,0.85);
  cursor:pointer; transition:all 0.2s; margin-bottom:-1px;
}
.tb:hover { color:rgba(210,185,115,0.88); }
.tb.on {
  color:rgba(230,205,135,1.0);
  border-bottom-color:rgba(215,180,80,0.70);
}

/* Tab content */
#tab-content {
  padding:12px 20px 14px;
  max-height:180px; overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.tab-pane { display:none; }
.tab-pane.on { display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap; }

/* ── CHRONOTYPE PANE ── */
#tp-chrono { align-items:center; gap:24px; }
.ctype-btns { display:flex; gap:5px; }
.cb {
  font-family:'Source Sans 3',sans-serif; font-size:10px;
  letter-spacing:0.12em; text-transform:uppercase;
  padding:8px 16px; border:1px solid rgba(130,158,130,0.18);
  border-radius:3px; background:rgba(5,14,7,0.55);
  color:rgba(165,198,172,0.78); cursor:pointer; transition:all 0.2s;
}
.cb:hover { border-color:rgba(170,145,65,0.30); color:rgba(190,165,105,0.72); }
.cb.on {
  border-color:rgba(190,158,65,0.55); color:rgba(215,188,118,0.95);
  background:rgba(12,26,14,0.80);
  box-shadow:0 0 12px rgba(160,128,48,0.10);
}
.cslider { display:flex; flex-direction:column; gap:4px; min-width:200px; }
.csl-row {
  display:flex; justify-content:space-between;
  font-size:10px; letter-spacing:0.10em;
  color:rgba(155,185,162,0.68);
}
#csl-val { color:rgba(190,162,85,0.72); }
.csl-track {
  position:relative; height:2px; border-radius:1px;
  background:linear-gradient(90deg,rgba(80,175,155,0.30),rgba(192,158,65,0.55),rgba(192,75,90,0.30));
}
#csl {
  -webkit-appearance:none; position:absolute; top:-9px; left:0;
  width:100%; height:18px; background:transparent; outline:none; cursor:pointer;
}
#csl::-webkit-slider-thumb {
  -webkit-appearance:none; width:14px; height:14px; border-radius:50%;
  background:rgba(200,162,65,0.92);
  box-shadow:0 0 8px rgba(200,162,65,0.55), 0 0 16px rgba(200,162,65,0.20);
  transition:box-shadow 0.2s;
}
#csl:hover::-webkit-slider-thumb {
  box-shadow:0 0 12px rgba(200,162,65,1), 0 0 22px rgba(200,162,65,0.40);
}
.chrono-preview {
  font-family:'Source Sans 3',sans-serif; font-size:17px; color:rgba(218,192,128,0.95);
}

/* ── SCIENCE PANE ── */
#tp-sci { align-items:flex-start; gap:16px; }
.sci-eq {
  font-family:'Source Sans 3',sans-serif; font-size:11px;
  color:rgba(225,192,105,0.95);
  background:rgba(0,0,0,0.40);
  border-left:2px solid rgba(188,155,60,0.38);
  padding:8px 14px; margin-bottom:6px;
  white-space:nowrap; overflow-x:auto;
  border-radius:0 3px 3px 0; letter-spacing:0.02em;
}
.sci-note {
  font-family:'Source Sans 3',sans-serif; font-size:12.5px; line-height:1.7;
  color:rgba(182,210,188,0.85); max-width:440px;
}

/* ── WAVE PANE ── */
#tp-waves { flex-direction:column; width:100%; gap:8px; }
#wc { display:block; width:100%; }
#wleg {
  display:flex; gap:16px; flex-wrap:wrap;
  font-size:10px; letter-spacing:0.07em;
  color:rgba(162,195,172,0.72);
}
.wle { display:flex; align-items:center; gap:5px; }
.wld { width:16px; height:1px; display:inline-block; }

/* ── LIVE INDICATOR ── */
.live-dot {
  display:inline-block; width:6px; height:6px; border-radius:50%;
  background:rgba(110,188,140,0.80);
  box-shadow:0 0 8px rgba(110,188,140,0.55);
  animation:blink 2s ease-in-out infinite;
  margin-right:6px; vertical-align:middle;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* ── SCROLLBAR ── */
#sidebar-left::-webkit-scrollbar { width:3px; }
#sidebar-left::-webkit-scrollbar-track { background:transparent; }
#sidebar-left::-webkit-scrollbar-thumb { background:rgba(140,165,130,0.18); border-radius:2px; }

/* Responsive — desktop sidebar collapse */
@media(max-width:900px){
  #shell {
    grid-template-columns: 0 1fr 0;
    grid-template-rows: 50px 1fr auto;
  }
  #sidebar-left, #sidebar-right { display:none; }
  #center-text { width:260px; }
  #ct-name { font-size:clamp(20px,5vw,32px); }

  /* Bottom panel — generous space */
  #tab-content { max-height:220px; padding:14px 16px 18px; }
  .tab-pane.on { gap:14px; }

  /* Tab bar — bigger touch targets */
  #tab-bar { padding:0 10px; }
  .tb { font-size:11px; padding:12px 12px 10px; letter-spacing:0.12em; }

  /* Phase strip — bigger dots */
  #phase-strip { gap:8px; padding:10px 12px 8px; }
  .ps-dot { width:36px; height:36px; font-size:13px; font-weight:500; }
}

/* Medium phones */
@media(max-width:600px){
  #shell { grid-template-rows: 46px 1fr auto; }
  #hdr { padding:0 10px; gap:6px; }
  .hdr-title { font-size:13px; letter-spacing:0.08em; }
  #hdr-clock { font-size:16px; }
  #hdr-date { font-size:9px; }
  #wake-btn { padding:5px 8px; gap:6px; }
  .wb-label { font-size:7px; }
  #wake-time-display { font-size:13px; }
  .wb-since { font-size:7px; }

  #center-text { width:240px; }
  #center-area { padding-bottom:8px; }
  #ct-num { font-size:10px; }
  #ct-range { font-size:12px; }
  #ct-until { font-size:10px; }
}

/* Small phones */
@media(max-width:400px){
  .hdr-title { font-size:11px; }
  #hdr-clock { font-size:14px; }
  #center-text { width:200px; }
  .ps-dot { width:30px; height:30px; font-size:11px; }
  .tb { font-size:10px; padding:10px 8px 8px; letter-spacing:0.08em; }
}

/* Short screens — keep phase info visible */
@media(max-width:900px) and (max-height:700px){
  #tab-content { max-height:160px; }
  #ct-range { display:none; }
  #ct-until { display:none; }
}

/* ── WAKE BUTTON ── */
#wake-btn {
  display:flex; align-items:center; gap:10px;
  padding:8px 14px; border:1px solid rgba(155,205,168,0.50);
  border-radius:4px; background:rgba(5,18,8,0.60);
  cursor:pointer; transition:all 0.22s ease;
  backdrop-filter:blur(4px); pointer-events:all;
}
#wake-btn:hover {
  border-color:rgba(168,215,175,0.45);
  background:rgba(8,24,12,0.75);
}
#wake-btn.pulsing {
  border-color:rgba(120,205,148,0.60);
  box-shadow:0 0 14px rgba(120,195,140,0.15);
}
.wb-icon {
  width:16px; height:16px;
  color:rgba(140,200,158,0.65); flex-shrink:0;
  transition:color 0.22s;
}
#wake-btn:hover .wb-icon { color:rgba(168,220,178,0.85); }
.wb-col { text-align:left; }
.wb-label {
  font-size:8px; letter-spacing:0.18em; text-transform:uppercase;
  color:rgba(148,195,165,0.80); display:block; line-height:1; margin-bottom:3px;
}
#wake-time-display {
  font-family:'Source Sans 3',sans-serif; font-size:16px; font-weight:600;
  color:rgba(185,230,195,1.0); display:block; line-height:1;
  letter-spacing:0.04em; transition:color 0.3s;
}
#wake-btn.pulsing #wake-time-display { color:rgba(130,220,158,0.95); }
.wb-since {
  font-size:8px; letter-spacing:0.08em;
  color:rgba(148,195,165,0.72); display:block; margin-top:2px;
  transition:opacity 0.4s;
}

/* ── MOBILE PHASE STRIP ── */
#phase-strip { display:none; }
@media(max-width:900px){
  #phase-strip {
    display:flex; justify-content:center; align-items:center;
    gap:6px; padding:8px 16px 6px;
    border-bottom:1px solid rgba(130,158,130,0.08);
  }
}
.ps-dot {
  width:32px; height:32px; border-radius:50%;
  border:1px solid rgba(145,178,152,0.38);
  display:flex; align-items:center; justify-content:center;
  font-family:'Source Sans 3',sans-serif; font-size:10px;
  letter-spacing:0.02em; cursor:pointer; transition:all 0.25s;
  background:rgba(8,22,10,0.75); color:rgba(175,210,182,0.85);
  pointer-events:all;
}
.ps-dot.active {
  color:rgba(215,195,148,0.95);
  border-color:rgba(190,158,65,0.55);
  background:rgba(14,28,15,0.80);
  box-shadow:0 0 10px rgba(160,128,48,0.22);
}
.ps-dot:hover:not(.active) {
  border-color:rgba(175,210,180,0.55);
  color:rgba(205,235,210,0.90);
}

/* ── TIMING CARDS ── */
.timing-row { display:flex; gap:6px; margin-bottom:10px; }
.timing-card {
  flex:1; padding:7px 9px;
  background:rgba(5,14,7,0.50);
  border:1px solid rgba(130,158,132,0.10);
  border-radius:3px;
}
.tc-label {
  font-size:8px; letter-spacing:0.16em; text-transform:uppercase;
  color:rgba(155,188,165,0.68); display:block; margin-bottom:3px;
}
.tc-val {
  font-family:'Source Sans 3',sans-serif; font-size:16px; font-weight:600;
  display:block; line-height:1;
}

/* Mobile-only tab */
.mobile-only { display:none; }
@media(max-width:900px){
  .mobile-only { display:inline-block; }
}

/* Forced-phase return */
#live-return {
  display:none; position:fixed; top:64px; left:50%;
  transform:translateX(-50%); z-index:300;
  font-family:'Source Sans 3',sans-serif;
  font-size:10px; letter-spacing:0.14em; text-transform:uppercase;
  padding:7px 16px; border:1px solid rgba(130,188,148,0.30);
  border-radius:3px; background:rgba(5,18,8,0.78);
  color:rgba(165,220,178,0.88); cursor:pointer;
  backdrop-filter:blur(6px); transition:opacity 0.3s;
  pointer-events:all;
}
#live-return:hover { color:rgba(160,215,175,0.95); border-color:rgba(160,215,175,0.50); }

/* ── WAKE TIME PICKER MODAL ── */
#wake-overlay {
  display:none; position:fixed; inset:0; z-index:500;
  background:rgba(2,8,3,0.70); backdrop-filter:blur(8px);
  align-items:center; justify-content:center;
}
#wake-overlay.open { display:flex; }

#wake-picker {
  background:rgba(8,22,10,0.96);
  border:1px solid rgba(155,205,168,0.50);
  border-radius:8px; padding:28px 32px 24px;
  width:min(340px, 92vw);
  box-shadow:0 0 40px rgba(0,0,0,0.60), 0 0 20px rgba(90,160,110,0.06);
  pointer-events:all;
}
.wp-title {
  font-family:'Source Sans 3',sans-serif; font-size:19px; color:rgba(200,178,120,0.90); margin-bottom:4px;
}
.wp-sub {
  font-size:9px; letter-spacing:0.16em; text-transform:uppercase;
  color:rgba(110,148,125,0.40); margin-bottom:24px;
}

/* Time scrubber */
.wp-scrubber {
  display:flex; align-items:center; justify-content:center;
  gap:0; margin-bottom:20px; user-select:none;
}
.wp-unit {
  display:flex; flex-direction:column; align-items:center; gap:4px;
}
.wp-arrow {
  width:44px; height:32px; background:none; border:none;
  color:rgba(140,185,155,0.45); font-size:18px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  border-radius:3px; transition:color 0.15s, background 0.15s;
  pointer-events:all;
}
.wp-arrow:hover { color:rgba(175,220,185,0.88); background:rgba(255,255,255,0.04); }
.wp-arrow:active { background:rgba(255,255,255,0.08); }
.wp-digits {
  font-family:'Source Sans 3',sans-serif; font-size:42px; font-weight:300;
  color:rgba(210,190,130,0.90); letter-spacing:0.02em;
  line-height:1; min-width:64px; text-align:center;
}
.wp-colon {
  font-family:'Source Sans 3',sans-serif; font-size:38px; font-weight:300;
  color:rgba(140,165,140,0.30); margin:0 4px; padding-bottom:8px;
}
.wp-unit-label {
  font-size:8px; letter-spacing:0.18em; text-transform:uppercase;
  color:rgba(100,138,115,0.35);
}

/* Quick presets */
.wp-presets {
  display:flex; gap:6px; flex-wrap:wrap; margin-bottom:22px;
}
.wp-preset {
  font-family:'Source Sans 3',sans-serif; font-size:10px;
  letter-spacing:0.10em; padding:7px 12px;
  border:1px solid rgba(130,158,130,0.18);
  border-radius:3px; background:rgba(5,14,7,0.55);
  color:rgba(120,155,132,0.55); cursor:pointer; transition:all 0.18s;
}
.wp-preset:hover {
  border-color:rgba(170,145,65,0.35); color:rgba(200,172,100,0.82);
}
.wp-preset.selected {
  border-color:rgba(190,158,65,0.55); color:rgba(215,188,118,0.95);
  background:rgba(14,28,15,0.80);
}

/* Action buttons */
.wp-actions { display:flex; gap:10px; justify-content:flex-end; }
.wp-cancel {
  font-family:'Source Sans 3',sans-serif; font-size:10px;
  letter-spacing:0.14em; text-transform:uppercase;
  padding:9px 18px; border:1px solid rgba(130,158,130,0.15);
  border-radius:3px; background:transparent;
  color:rgba(165,198,172,0.78); cursor:pointer; transition:all 0.2s;
}
.wp-cancel:hover { color:rgba(165,190,168,0.70); }
.wp-confirm {
  font-family:'Source Sans 3',sans-serif; font-size:10px;
  letter-spacing:0.14em; text-transform:uppercase;
  padding:9px 22px; border:1px solid rgba(140,188,152,0.35);
  border-radius:3px; background:rgba(12,32,15,0.75);
  color:rgba(165,218,175,0.82); cursor:pointer; transition:all 0.2s;
}
.wp-confirm:hover {
  background:rgba(18,42,20,0.88);
  border-color:rgba(165,210,175,0.60);
  color:rgba(185,230,195,0.95);
  box-shadow:0 0 12px rgba(120,185,140,0.12);
}

/* ── ARTWORK UPLOAD BUTTON ── */
#artwork-upload-wrap {
  position:fixed; bottom:0; left:50%;
  transform:translateX(-50%); z-index:400;
  pointer-events:all;
}
#artwork-label {
  display:flex; align-items:center; gap:7px;
  padding:8px 16px 8px 12px;
  background:rgba(6,20,8,0.85);
  border:1px solid rgba(140,188,152,0.30);
  border-bottom:none; border-radius:6px 6px 0 0;
  cursor:pointer; transition:all 0.22s;
  backdrop-filter:blur(8px);
}
#artwork-label:hover {
  background:rgba(10,30,12,0.92);
  border-color:rgba(168,215,178,0.55);
}
#artwork-label svg {
  width:14px; height:14px;
  color:rgba(148,205,165,0.82); flex-shrink:0;
}
#artwork-label-text {
  font-family:'Source Sans 3',sans-serif; font-size:10px;
  letter-spacing:0.16em; text-transform:uppercase;
  color:rgba(165,215,178,0.85); white-space:nowrap;
}
#artwork-loaded-name {
  font-size:9px; letter-spacing:0.06em;
  color:rgba(140,185,155,0.52); display:none; margin-top:1px;
}
#artwork-file { display:none; }
#artwork-upload-wrap.loaded #artwork-label {
  border-color:rgba(120,188,140,0.50);
  background:rgba(6,24,10,0.70);
}
#artwork-upload-wrap.loaded #artwork-label svg { color:rgba(120,205,148,0.88); }
#artwork-upload-wrap.loaded #artwork-loaded-name { display:block; }
@media(max-width:900px){
  #artwork-upload-wrap {
    bottom:auto; top:50px; right:8px; left:auto; transform:none; z-index:20;
  }
  #artwork-label {
    border-radius:4px; border:1px solid rgba(140,188,152,0.25);
    padding:5px 10px 5px 8px; gap:5px;
  }
  #artwork-label svg { width:12px; height:12px; }
  #artwork-label-text { font-size:9px; }
}

/* ── ARTWORK STATUS TOAST ── */
#art-toast {
  display:none; position:fixed; top:68px; left:50%;
  transform:translateX(-50%); z-index:600;
  font-family:'Source Sans 3',sans-serif;
  font-size:10px; letter-spacing:0.14em; text-transform:uppercase;
  padding:8px 18px; border-radius:4px;
  background:rgba(6,22,10,0.94);
  border:1px solid rgba(140,200,158,0.40);
  color:rgba(165,220,178,0.92);
  pointer-events:none; white-space:nowrap;
}
</style>
</head>
<body>

<!-- WAKE TIME PICKER MODAL -->
<div id="wake-overlay">
  <div id="wake-picker">
    <div class="wp-title">When did you wake?</div>
    <div class="wp-sub">Set your actual wake time</div>

    <div class="wp-scrubber">
      <div class="wp-unit">
        <button class="wp-arrow" id="wp-hr-up">&#9650;</button>
        <span class="wp-digits" id="wp-hr">06</span>
        <button class="wp-arrow" id="wp-hr-dn">&#9660;</button>
        <div class="wp-unit-label">hour</div>
      </div>
      <div class="wp-colon">:</div>
      <div class="wp-unit">
        <button class="wp-arrow" id="wp-mn-up">&#9650;</button>
        <span class="wp-digits" id="wp-mn">30</span>
        <button class="wp-arrow" id="wp-mn-dn">&#9660;</button>
        <div class="wp-unit-label">min</div>
      </div>
    </div>

    <div class="wp-presets">
      <button class="wp-preset" data-h="5" data-m="0">05:00</button>
      <button class="wp-preset" data-h="5" data-m="30">05:30</button>
      <button class="wp-preset" data-h="6" data-m="0">06:00</button>
      <button class="wp-preset" data-h="6" data-m="30">06:30</button>
      <button class="wp-preset" data-h="7" data-m="0">07:00</button>
      <button class="wp-preset" data-h="7" data-m="30">07:30</button>
      <button class="wp-preset" data-h="8" data-m="0">08:00</button>
      <button class="wp-preset" data-h="8" data-m="30">08:30</button>
      <button class="wp-preset" data-h="9" data-m="0">09:00</button>
      <button class="wp-preset" data-h="9" data-m="30">09:30</button>
      <button class="wp-preset" id="wp-now-preset">Now</button>
    </div>

    <div class="wp-actions">
      <button class="wp-cancel" id="wp-cancel">Cancel</button>
      <button class="wp-confirm" id="wp-confirm">Set wake time</button>
    </div>
  </div>
</div>

<canvas id="c"></canvas>
<div id="tagline"><span id="tagline-text">The Clock that tells you where you are, not where the sun is</span></div>

<div id="art-toast">Loading&#8230;</div>
<button id="live-return" onclick="returnToLive()">&#8617; return to live</button>

<div id="shell">

  <!-- HEADER -->
  <header id="hdr">
    <div>
      <div class="hdr-title">Marouf Resonance Clock</div>
    </div>
    <button id="wake-btn" title="Set your wake time">
      <svg class="wb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <div class="wb-col">
        <span class="wb-label">Wake time</span>
        <span id="wake-time-display">&mdash;</span>
        <span class="wb-since" id="wake-since">tap to set &rarr;</span>
      </div>
    </button>
    <div style="text-align:right">
      <div id="hdr-clock">00:00:00</div>
      <div id="hdr-date">&mdash;</div>
    </div>
  </header>

  <!-- LEFT — phase navigator -->
  <aside id="sidebar-left">
    <div class="sidebar-label">Phases</div>
  </aside>

  <!-- CENTER -->
  <div id="center-area">
    <div id="center-text">
      <span id="ct-num">Phase 1 of 9</span>
      <span id="ct-name">Rest</span>
      <span id="ct-range">&mdash; &ndash; &mdash;</span>
      <span id="ct-until">&mdash;</span>
    </div>
  </div>

  <!-- RIGHT — bio + stats -->
  <aside id="sidebar-right">
    <div class="sr-label" id="sr-phase-label">Current Phase</div>
    <div class="timing-row">
      <div class="timing-card">
        <span class="tc-label">Wake</span>
        <span class="tc-val" id="sr-wake" style="color:rgba(168,212,178,0.78)">&mdash;</span>
      </div>
      <div class="timing-card">
        <span class="tc-label">Next</span>
        <span class="tc-val" id="sr-next" style="color:rgba(210,185,118,0.75)">&mdash;</span>
      </div>
      <div class="timing-card">
        <span class="tc-label">In</span>
        <span class="tc-val" id="sr-countdown" style="color:rgba(175,200,178,0.60)">&mdash;</span>
      </div>
    </div>
    <div id="bio-card">
      <p id="bio-text">&mdash;</p>
    </div>
    <div class="stat-row">
      <div class="stat-item">
        <span class="stat-val" style="color:rgba(118,198,158,0.85)">2.1&deg;</span>
        <span class="stat-lbl">angular deviation<br>artwork alignment</span>
      </div>
      <div class="stat-item">
        <span class="stat-val" style="color:rgba(108,168,218,0.85);font-size:14px;letter-spacing:0.03em">p&thinsp;&lt;&thinsp;.001</span>
        <span class="stat-lbl">monte carlo<br>n = 100,000</span>
      </div>
      <div class="stat-item">
        <span class="stat-val" style="color:rgba(212,178,108,0.85)">7/9</span>
        <span class="stat-lbl">phases within<br>1&sigma; of prediction</span>
      </div>
    </div>
  </aside>

  <!-- BOTTOM PANEL -->
  <footer id="bottom-panel">
    <div id="phase-strip"></div>
    <div id="tab-bar">
      <span class="live-dot"></span>
      <button class="tb mobile-only" id="tb-phase" data-pane="tp-phase">Phase</button>
      <button class="tb" data-pane="tp-chrono">Chronotype</button>
      <button class="tb" data-pane="tp-sci">Science</button>
      <button class="tb" data-pane="tp-waves">Hormones</button>
    </div>
    <div id="tab-content">

      <!-- PHASE (mobile only) -->
      <div class="tab-pane" id="tp-phase">
        <div style="width:100%">
          <div style="font-family:'Source Sans 3',sans-serif;font-size:12px;letter-spacing:0.14em;text-transform:uppercase;color:rgba(165,200,172,0.78);margin-bottom:8px;" id="tp-phase-num">Phase 1 of 9</div>
          <div style="font-family:'Source Sans 3',sans-serif;font-size:26px;font-weight:600;margin-bottom:10px;transition:color 0.5s;" id="tp-phase-name">&mdash;</div>
          <div style="font-family:'Source Sans 3',sans-serif;font-size:14px;letter-spacing:0.06em;color:rgba(215,188,105,0.88);margin-bottom:12px;" id="tp-phase-range">&mdash; &ndash; &mdash;</div>
          <p style="font-family:'Source Sans 3',sans-serif;font-size:15px;line-height:1.7;color:rgba(195,225,200,0.88);max-width:560px;" id="tp-phase-bio">&mdash;</p>
        </div>
      </div>

      <!-- CHRONOTYPE -->
      <div class="tab-pane" id="tp-chrono">
        <div>
          <div class="sr-label" style="margin-bottom:8px;color:rgba(165,200,172,0.78)">Chronotype</div>
          <div class="ctype-btns">
            <button class="cb on" data-v="0">Morning</button>
            <button class="cb"    data-v="15">Intermediate</button>
            <button class="cb"    data-v="30">Evening</button>
          </div>
        </div>
        <div class="cslider">
          <div class="csl-row"><span>Phase shift</span><span id="csl-val">+0.0 h</span></div>
          <div class="csl-track">
            <input type="range" id="csl" min="0" max="30" value="0" step="1">
          </div>
          <div class="csl-row"><span>0 h</span><span>+3.0 h</span></div>
        </div>
        <div>
          <div class="sr-label" style="margin-bottom:5px;color:rgba(165,200,172,0.78)">Natural wake</div>
          <div class="chrono-preview" id="chrono-lbl">Morning</div>
          <div style="font-size:10px;color:rgba(162,198,170,0.70);margin-top:3px" id="chrono-wake">Wake &asymp; 06:30</div>
        </div>
      </div>

      <!-- SCIENCE -->
      <div class="tab-pane" id="tp-sci">
        <div style="flex:0 0 auto">
          <div class="sci-eq">F(t) = 0.5&middot;C(t) + 0.3&middot;T(t) + 0.2&middot;M(t)</div>
          <div class="sci-eq">Phase boundaries = zeros of F&prime;(t) &cup; F&Prime;(t)</div>
        </div>
        <p class="sci-note">
          Composite of three circadian markers: cortisol (Brabant 1989),
          core body temperature (Refinetti 2010), and melatonin onset (Lewy 1999).
          Phase boundaries occur at zeros of F&prime; and F&Prime;.
        </p>
      </div>

      <!-- WAVES -->
      <div class="tab-pane" id="tp-waves">
        <canvas id="wc" height="72"></canvas>
        <div id="wleg">
          <span class="wle"><span class="wld" style="background:#c07040;height:1px"></span>Cortisol</span>
          <span class="wle"><span class="wld" style="background:#408080;height:1px"></span>Temperature</span>
          <span class="wle"><span class="wld" style="background:#907090;height:1px"></span>Melatonin</span>
          <span class="wle"><span class="wld" style="background:rgba(195,162,72,0.9);height:2px"></span>Composite F(t)</span>
          <span class="wle"><span class="wld" style="background:rgba(140,180,148,0.40);width:1px;height:12px"></span>Phase boundary</span>
        </div>
      </div>

    </div>
  </footer>

</div><!-- shell -->

<script>
// ════════════════════════════════════════════════════════════════
// DATA — Phase names, colours, and concise descriptions
// ════════════════════════════════════════════════════════════════
const TAU = 24, TP = Math.PI * 2;

const CLR = [
  {h:215,s:55,l:58}, {h:195,s:50,l:55}, {h:28,s:70,l:58},
  {h:45,s:72,l:58},  {h:12,s:65,l:56},  {h:290,s:40,l:60},
  {h:152,s:48,l:52}, {h:130,s:42,l:50}, {h:248,s:44,l:62}
];
const NAMES = [
  "Rest","Preparation","Energy Rise","Focus","Peak",
  "Reflection","Renewal","Transition","Closure"
];
// Concise bio — max ~20 words each for readability
const BIO = [
  "Deep NREM sleep. Growth hormone pulses through the body. Cells repair; memory consolidates.",
  "The body wakes before the mind. Cortisol climbs steeply before the alarm sounds.",
  "Rapid hormonal surge. Melatonin extinguishes. Metabolism accelerates into full active state.",
  "Cortisol peaks. Analytical reasoning, focused attention, and working memory at their zenith.",
  "Physical apex. Muscle strength, lung capacity, and reaction time converge at maximum.",
  "Cortisol descends. A second oscillator troughs. The afternoon dip is biological, not laziness.",
  "Core temperature peaks. A natural second wind rises for sustained physical exertion.",
  "Cortisol drops steeply. Melatonin ascends. Metabolic shift from breakdown to rebuilding begins.",
  "Melatonin rises. Temperature falls. The body engineers conditions for deep sleep to return.",
];

// ════════════════════════════════════════════════════════════════
// PHYSIOLOGICAL MODEL — Fourier oscillators
// ════════════════════════════════════════════════════════════════
const osc = (peak, amps) => t =>
  amps.reduce((v,A,k) => v + A * Math.cos((k+1)*TP*(t-peak)/TAU), 0);

const rawC = osc(7.5, [1,.38,.18,.08]);   // Cortisol
const rawT = osc(17,  [1,.22,.08]);        // Temperature
const rawM = osc(3,   [1,.35,.12]);        // Melatonin

const nrm = (fn, N=600) => {
  const vs = Array.from({length:N}, (_,i)=>fn(i*TAU/N));
  const lo = Math.min(...vs), hi = Math.max(...vs);
  return t => (fn(t)-lo)/(hi-lo)*2-1;
};
const Crt = nrm(rawC), Tmp = nrm(rawT), Mel = nrm(rawM);
const F   = t => .5*Crt(t) + .3*Tmp(t) + .2*Mel(t);
const D1  = (f,t) => (f(t+1e-4)-f(t-1e-4))*5000;
const D2  = (f,t) => (f(t+1e-4)-2*f(t)+f(t-1e-4))*1e8;

function findZeros(fn, N=50000) {
  const dt=TAU/N; const z=[]; let p=fn(0);
  for(let i=1;i<=N;i++){
    const t=i*dt, c=fn(t);
    if(p*c<0){
      let a=(i-1)*dt, b=t;
      for(let k=0;k<28;k++){const m=(a+b)/2; fn(a)*fn(m)<=0?b=m:a=m;}
      z.push((a+b)/2);
    } p=c;
  } return z;
}

function buildPhaseTimes() {
  const all = [...findZeros(t=>D1(F,t)), ...findZeros(t=>D2(F,t))].sort((a,b)=>a-b);
  const mg = []; for(const t of all) if(!mg.length||t-mg[mg.length-1]>0.4) mg.push(t);
  const sc = mg.map(t=>({t, s:Math.abs(D1(F,t))+.4*Math.abs(F(t))}));
  sc.sort((a,b)=>b.s-a.s);
  const t9 = sc.slice(0,9).map(x=>x.t).sort((a,b)=>a-b);
  const mi = t9.map(t=>F(t)).reduce((bi,v,i,a)=>v<a[bi]?i:bi, 0);
  const rot = [...t9.slice(mi), ...t9.slice(0,mi)];
  return rot.map(t=>(t-rot[0]+TAU)%TAU);
}

const BASE_TIMES = buildPhaseTimes();
let chronoOff = 0;
const getTimes = () => BASE_TIMES.map(t=>(t+chronoOff)%TAU);

// Wake time state
let wakeTimestamp = null;
let wakeHour      = 6.5;

// ════════════════════════════════════════════════════════════════
// CANVAS ENGINE
// ════════════════════════════════════════════════════════════════
const cv = document.getElementById('c');
const cx = cv.getContext('2d');
let W, H, OX, OY, R;

// ── ARTWORK IMAGE — loaded via file upload ──────────────────────
let mandalaImg    = null;
let mandalaLoaded = false;

// ── ARTWORK TRACE SYSTEM ────────────────────────────────────────
// Inspired by Mandala Unfold: each phase leaves an opaque ghost
// of the artwork at its biological angle. Traces accumulate as
// the day progresses, building a 9-fold composite.
//
// traceCanvas: offscreen canvas that persists across frames.
//   Only cleared on phase change or artwork reload.
// tracedPhases: Set of phase indices whose traces are committed.
//
// The trace uses 'lighten' blend (max per channel) on the dark
// background — same adaptive logic as Mandala Unfold v10.
let traceCanvas  = null;
let traceCtx     = null;
let tracedPhases = new Set();
let lastTracePhase = -1;

function initTraceCanvas() {
  traceCanvas = document.createElement('canvas');
  traceCanvas.width  = W;
  traceCanvas.height = H;
  traceCtx = traceCanvas.getContext('2d');
  traceCtx.clearRect(0, 0, W, H);
  tracedPhases.clear();
  lastTracePhase = -1;
}

function resize() {
  W = cv.width  = window.innerWidth;
  H = cv.height = window.innerHeight;

  const hdr  = document.getElementById('hdr');
  const bp   = document.getElementById('bottom-panel');
  const sbL  = document.getElementById('sidebar-left');
  const sbR  = document.getElementById('sidebar-right');

  const hh  = hdr ? hdr.offsetHeight : 56;
  const bh  = bp  ? bp.offsetHeight  : 130;
  const slw = (sbL && sbL.offsetWidth > 10) ? sbL.offsetWidth : 0;
  const srw = (sbR && sbR.offsetWidth > 10) ? sbR.offsetWidth : 0;

  const availW = W - slw - srw;
  // Reserve space for tagline on mobile (30px)
  const isMobile = W <= 900;
  const tagSpace = isMobile ? 34 : 0;
  const availH = H - hh - bh - tagSpace;

  OX = slw + availW / 2;
  OY = hh + tagSpace + availH / 2;

  // Clock face — slightly smaller on mobile to leave breathing room
  const slot = Math.min(availW / 2, availH / 2) - 10;
  R  = Math.max(slot / (isMobile ? 1.25 : 1.15), 80);

  // Re-init trace canvas on resize
  initTraceCanvas();

  // Position tagline above the 12 o'clock mark, clear of hour labels
  const tag = document.getElementById('tagline');
  if(tag) {
    const tagTop = OY - R * 1.08 - 44;
    tag.style.top  = Math.max(hh + 4, tagTop) + 'px';
    tag.style.left = OX + 'px';
  }
}
resize();
window.addEventListener('resize', () => { resize(); });

const hs = (h,s,l,a=1) => `hsla(${h},${s}%,${l}%,${a})`;

// ── SPORES ──────────────────────────────────────────────────────
const spores = [];
function spawnSpore(x,y,h,s,l) {
  const a = Math.random()*TP, sp = .3+Math.random()*.9;
  spores.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
    life:1, decay:.012+Math.random()*.018, size:1.2+Math.random()*1.8, h,s,l});
}

// ── BACKGROUND ──────────────────────────────────────────────────
function drawBG(t) {
  const bg = cx.createRadialGradient(OX, OY*.7, 0, OX, OY, Math.max(W,H)*.9);
  bg.addColorStop(0, '#143825');
  bg.addColorStop(.35, '#0a1c10');
  bg.addColorStop(1, '#040a06');
  cx.fillStyle = bg; cx.fillRect(0,0,W,H);

  const br = .5+.5*Math.sin(t*.0009);
  const cg = cx.createRadialGradient(OX,OY,0,OX,OY,R*2.0);
  cg.addColorStop(0, `rgba(200,160,65,${.10+br*.06})`);
  cg.addColorStop(.5, `rgba(140,180,120,${.03+br*.02})`);
  cg.addColorStop(1, 'transparent');
  cx.fillStyle = cg; cx.fillRect(0,0,W,H);

  // Ghost ideal-spacing spokes
  for(let i=0;i<9;i++){
    const a = (i/9)*TP - Math.PI/2;
    cx.beginPath();
    cx.moveTo(OX+R*.44*Math.cos(a), OY+R*.44*Math.sin(a));
    cx.lineTo(OX+R*1.12*Math.cos(a), OY+R*1.12*Math.sin(a));
    cx.strokeStyle = 'rgba(185,150,60,0.10)';
    cx.lineWidth = .6; cx.setLineDash([2,8]); cx.stroke(); cx.setLineDash([]);
  }
}

// ── ORGANIC PETAL ───────────────────────────────────────────────
function drawPetal(idx, startA, endA, breath, t, active) {
  const {h,s,l} = CLR[idx];
  const span = (endA-startA+TP)%TP || TP/9;
  const mid  = startA + span/2;
  const tR   = R*.22 + Math.sin(t*.0007+idx)*.008*R;
  const oR   = R * breath;
  const N    = 28;

  const outerPts = [];
  for(let i=0;i<=N;i++){
    const f=i/N, a=startA+f*span;
    const bulge = oR*(1+Math.sin(f*Math.PI)*.10) + Math.sin(f*Math.PI*3+t*.0006+idx*1.4)*R*.012;
    outerPts.push({x:OX+bulge*Math.cos(a), y:OY+bulge*Math.sin(a)});
  }
  const cR   = tR*.82;
  const il   = {x:OX+tR*Math.cos(startA), y:OY+tR*Math.sin(startA)};
  const ir   = {x:OX+tR*Math.cos(endA),   y:OY+tR*Math.sin(endA)};
  const cpL  = {x:OX+(tR*.5+oR*.5)*Math.cos(startA-span*.05), y:OY+(tR*.5+oR*.5)*Math.sin(startA-span*.05)};
  const cpR  = {x:OX+(tR*.5+oR*.5)*Math.cos(endA+span*.05),   y:OY+(tR*.5+oR*.5)*Math.sin(endA+span*.05)};

  function path() {
    cx.beginPath(); cx.moveTo(il.x, il.y);
    cx.quadraticCurveTo(cpL.x, cpL.y, outerPts[0].x, outerPts[0].y);
    for(let i=1;i<=N;i++) cx.lineTo(outerPts[i].x, outerPts[i].y);
    cx.quadraticCurveTo(cpR.x, cpR.y, ir.x, ir.y);
    cx.quadraticCurveTo(OX+cR*Math.cos(mid), OY+cR*Math.sin(mid), il.x, il.y);
    cx.closePath();
  }

  // BOOSTED opacity — petals are the main visual feature
  const alpha = active ? .45+.18*Math.sin(t*.0017) : .18+.06*Math.sin(t*.0008+idx*.8);
  path();
  const pg = cx.createRadialGradient(OX+oR*.58*Math.cos(mid), OY+oR*.58*Math.sin(mid), 0, OX, OY, oR*1.35);
  pg.addColorStop(0, hs(h,s+12,l+14, alpha*(active?1.4:1)));
  pg.addColorStop(.6, hs(h,s+5,l+5, alpha));
  pg.addColorStop(1, hs(h,s,l-5, alpha*.35));
  cx.fillStyle = pg; cx.fill();

  if(active){
    cx.save(); cx.globalCompositeOperation='screen'; path();
    const bl = cx.createRadialGradient(OX+oR*.5*Math.cos(mid),OY+oR*.5*Math.sin(mid),0,OX+oR*.5*Math.cos(mid),OY+oR*.5*Math.sin(mid),oR*.65);
    bl.addColorStop(0, hs(h,s+25,l+28,.22)); bl.addColorStop(1,'transparent');
    cx.fillStyle = bl; cx.fill(); cx.restore();
  }

  path();
  cx.strokeStyle = active ? hs(h,s+18,l+10,.85+.15*Math.sin(t*.0017)) : hs(h,s+5,l+5,.35+.08*Math.sin(t*.001+idx));
  cx.lineWidth = active ? 1.6 : .8; cx.stroke();

  // Vein
  cx.beginPath();
  cx.moveTo(OX+tR*.9*Math.cos(mid), OY+tR*.9*Math.sin(mid));
  cx.lineTo(OX+oR*.87*Math.cos(mid), OY+oR*.87*Math.sin(mid));
  cx.strokeStyle = hs(h,s,l+18, active?.40:.15);
  cx.lineWidth = .8; cx.stroke();

  // Numeral — brighter and more visible
  const nr = oR*.62+tR*.45;
  cx.save();
  cx.translate(OX+nr*Math.cos(mid), OY+nr*Math.sin(mid));
  cx.rotate(mid+Math.PI/2);
  cx.font = active ? `600 ${Math.round(R*.07)}px 'Source Sans 3'` : `${Math.round(R*.055)}px 'Source Sans 3'`;
  cx.textAlign='center'; cx.textBaseline='middle';
  cx.fillStyle = active ? hs(h,s+5,l,.95) : hs(h,s,l+5,.55);
  cx.fillText(idx+1, 0, 0); cx.restore();

  if(active && Math.random()<.22){
    const a2 = startA+Math.random()*span;
    spawnSpore(OX+oR*(1+Math.random()*.12)*Math.cos(a2), OY+oR*(1+Math.random()*.12)*Math.sin(a2), h,s,l);
  }
}

// ════════════════════════════════════════════════════════════════
// CENTRE — 9-fold artwork engine with Mandala Unfold trace
// ════════════════════════════════════════════════════════════════
//
// Integration of Mandala Unfold "trace" concept:
// As the live clock moves through each of the 9 phases, the artwork
// image is drawn at that phase's biological angle. When a phase
// completes (the clock moves to the next phase), the artwork's
// impression at that angle is "stamped" into a persistent trace
// layer using the lighten blend mode (max per channel — same as
// Mandala Unfold v10 for dark backgrounds). This builds up a
// 9-fold rotational composite over the course of the day, with
// each completed phase leaving a visible ghost of itself.
//
// The active phase artwork is always drawn at full opacity on top.
// Past phases show as faded, blended traces.
// Future phases show as very faint previews.
//
// This is scientifically coherent because:
// - Each rotation angle = midpoint of a biological phase arc
// - The 9 angles are derived from F'(t) and F''(t) zeros
// - The trace accumulation mirrors the body's daily progression
//   through circadian states
// ════════════════════════════════════════════════════════════════

function commitTraceForPhase(phaseIdx, times) {
  if (!mandalaLoaded || !mandalaImg || !traceCtx) return;
  if (tracedPhases.has(phaseIdx)) return;

  const clipR = R * 0.45;
  const imgW  = mandalaImg.naturalWidth;
  const imgH  = mandalaImg.naturalHeight;
  const scale = (clipR * 2.5) / Math.min(imgW, imgH);
  const dw    = imgW * scale;
  const dh    = imgH * scale;

  // Compute biological midpoint angle for this phase
  const sT = times[phaseIdx], eT = times[(phaseIdx + 1) % 9];
  let sA = (sT / TAU) * TP - Math.PI / 2;
  let eA = (eT / TAU) * TP - Math.PI / 2;
  if (phaseIdx === 8 && eA <= sA) eA += TP;
  if (eA <= sA) eA += TP;
  const midA = sA + (eA - sA) / 2;

  // Stamp artwork into persistent offscreen canvas at this phase angle
  // source-over preserves true artwork colours; high alpha for clear visibility
  traceCtx.save();
    traceCtx.beginPath();
    traceCtx.arc(OX, OY, clipR, 0, TP);
    traceCtx.clip();
    traceCtx.globalCompositeOperation = 'source-over';
    traceCtx.globalAlpha = 0.55;
    traceCtx.translate(OX, OY);
    traceCtx.rotate(midA);
    traceCtx.drawImage(mandalaImg, -dw / 2, -dh / 2, dw, dh);
  traceCtx.restore();

  tracedPhases.add(phaseIdx);
}

function drawCentre(phase, t) {
  const {h,s,l} = CLR[phase];
  const clipR   = R * 0.45;

  // Establish circular clip
  cx.save();
  cx.beginPath();
  cx.arc(OX, OY, clipR, 0, TP);
  cx.clip();

  // Very dark base — not pure black so artwork breathes
  cx.fillStyle = 'rgba(4,12,6,0.97)';
  cx.fillRect(OX - clipR, OY - clipR, clipR * 2, clipR * 2);

  if (mandalaLoaded && mandalaImg && mandalaImg.naturalWidth > 0) {
    const imgW  = mandalaImg.naturalWidth;
    const imgH  = mandalaImg.naturalHeight;
    const scale = (clipR * 2.5) / Math.min(imgW, imgH);
    const dw    = imgW * scale;
    const dh    = imgH * scale;

    const times  = getTimes();
    const livePh = whichPhase(new Date(), times);

    // ── TRACE ACCUMULATION ──
    // Commit traces for completed phases into the persistent offscreen canvas
    if (livePh !== lastTracePhase) {
      if (lastTracePhase >= 0 && lastTracePhase !== livePh) {
        commitTraceForPhase(lastTracePhase, times);
      }
      // Handle page reload mid-day — commit all phases before current
      for (let i = 0; i < livePh; i++) {
        commitTraceForPhase(i, times);
      }
      lastTracePhase = livePh;
    }

    // ── DRAW PERSISTENT TRACE LAYER (accumulated past-phase ghosts) ──
    if (traceCanvas && tracedPhases.size > 0) {
      cx.save();
      cx.globalCompositeOperation = 'source-over';
      cx.globalAlpha = 0.85;
      cx.drawImage(traceCanvas, 0, 0);
      cx.restore();
    }

    // ── DRAW LIVE LAYERS ──
    // Z-order: future (bottom, faint ghost) → past (mid, clear) → active (top, vivid)
    // source-over throughout — preserves true artwork colours
    const order = [];
    for (let i = 0; i < 9; i++) {
      const isActive = (i === phase);
      const isPast   = (i < livePh);
      order.push({ i, isActive, isPast, z: isActive ? 2 : isPast ? 1 : 0 });
    }
    order.sort((a, b) => a.z - b.z);

    for (const { i, isActive, isPast } of order) {
      const sT = times[i], eT = times[(i + 1) % 9];
      let sA = (sT / TAU) * TP - Math.PI / 2;
      let eA = (eT / TAU) * TP - Math.PI / 2;
      if (i === 8 && eA <= sA) eA += TP;
      if (eA <= sA) eA += TP;
      const midA = sA + (eA - sA) / 2;

      // Clear opacity hierarchy — artwork stays true-colour
      const opacity = isActive ? 0.95
                    : isPast   ? 0.50
                    :            0.10;

      cx.save();
        cx.globalCompositeOperation = 'source-over';
        cx.globalAlpha = opacity;
        cx.translate(OX, OY);
        cx.rotate(midA);
        if (isActive) {
          const pulse = 1.0 + 0.018 * Math.sin(t * 0.0017);
          cx.scale(pulse, pulse);
        }
        cx.drawImage(mandalaImg, -dw / 2, -dh / 2, dw, dh);
      cx.restore();
    }

    cx.globalCompositeOperation = 'source-over';

  } else {
    // ── Generative fallback (no image loaded) ────────────────────
    const times  = getTimes();
    const livePh = whichPhase(new Date(), times);
    const nb     = 0.5 + 0.5 * Math.sin(t * 0.0019);
    const ng     = cx.createRadialGradient(OX, OY, 0, OX, OY, clipR * 0.88);
    ng.addColorStop(0, hs(h, s+10, l+10, 0.25 + nb * 0.15));
    ng.addColorStop(.6, hs(h, s, l, 0.08 + nb * 0.05));
    ng.addColorStop(1, 'transparent');
    cx.beginPath(); cx.arc(OX, OY, clipR * 0.88, 0, TP);
    cx.fillStyle = ng; cx.fill();

    cx.globalCompositeOperation = 'source-over';
    for (let i = 0; i < 9; i++) {
      const sT = times[i], eT = times[(i + 1) % 9];
      let sA = (sT / TAU) * TP - Math.PI / 2;
      let eA = (eT / TAU) * TP - Math.PI / 2;
      if (i === 8 && eA <= sA) eA += TP;
      if (eA <= sA) eA += TP;
      const midA = sA + (eA - sA) / 2;
      const isAct  = (i === phase);
      const isPast = (i < livePh);
      const dr = clipR * 0.65;
      const pa = isAct  ? 1.0
               : isPast ? 0.70 + 0.10 * Math.sin(t * 0.001 + i * 0.4)
               :          0.30 + 0.08 * Math.sin(t * 0.001 + i * 0.7);
      const dotR = isAct ? 5 : 2.5;
      cx.beginPath();
      cx.arc(OX + dr * Math.cos(midA), OY + dr * Math.sin(midA), dotR, 0, TP);
      cx.fillStyle = hs(CLR[i].h, CLR[i].s+8, CLR[i].l + 15, pa);
      cx.fill();
      if (isAct) {
        const dg = cx.createRadialGradient(OX + dr * Math.cos(midA), OY + dr * Math.sin(midA), 0,
          OX + dr * Math.cos(midA), OY + dr * Math.sin(midA), 14);
        dg.addColorStop(0, hs(CLR[i].h, CLR[i].s+15, CLR[i].l+20, 0.50));
        dg.addColorStop(1, 'transparent');
        cx.beginPath();
        cx.arc(OX + dr * Math.cos(midA), OY + dr * Math.sin(midA), 14, 0, TP);
        cx.fillStyle = dg; cx.fill();
      }
    }
    cx.globalCompositeOperation = 'source-over';
  }

  cx.restore(); // removes clip

  // Phase-hued glow ring outside clip — BRIGHT
  const nb2 = 0.5 + 0.5 * Math.sin(t * 0.0019);
  const ng2 = cx.createRadialGradient(OX, OY, clipR * 0.78, OX, OY, clipR * 1.15);
  ng2.addColorStop(0, hs(h, s+10, l+10, 0.40 + nb2 * 0.18));
  ng2.addColorStop(.6, hs(h, s, l, 0.12 + nb2 * 0.08));
  ng2.addColorStop(1, 'transparent');
  cx.beginPath(); cx.arc(OX, OY, clipR * 1.15, 0, TP);
  cx.fillStyle = ng2; cx.fill();

  // Ring border — more visible
  cx.beginPath(); cx.arc(OX, OY, clipR, 0, TP);
  cx.strokeStyle = hs(h, s+10, l+8, 0.50 + 0.15 * Math.sin(t * 0.0019));
  cx.lineWidth = 1.3; cx.stroke();

  // Gold seed — brighter
  const sg = cx.createRadialGradient(OX, OY, 0, OX, OY, 7);
  sg.addColorStop(0, 'rgba(235,200,90,1.0)');
  sg.addColorStop(.5, 'rgba(218,180,80,0.50)');
  sg.addColorStop(1, 'transparent');
  cx.beginPath(); cx.arc(OX, OY, 7, 0, TP);
  cx.fillStyle = sg; cx.fill();
}

// ── HOUR RING ───────────────────────────────────────────────────
function drawRing(t) {
  for(let i=0;i<24;i++){
    const a=(i/24)*TP-Math.PI/2;
    const r0=R*1.08, r1=r0+(i%6===0?13:i%3===0?8:4);
    cx.beginPath();
    cx.moveTo(OX+r0*Math.cos(a),OY+r0*Math.sin(a));
    cx.lineTo(OX+r1*Math.cos(a),OY+r1*Math.sin(a));
    cx.strokeStyle = i%6===0
      ? `rgba(228,200,95,${.88+.12*Math.sin(t*.001+i)})`
      : `rgba(185,212,188,${.50+.10*Math.sin(t*.0008+i*.4)})`;
    cx.lineWidth = i%6===0 ? 1.4 : .7; cx.stroke();
    if(i%6===0){
      const lr=r0+20;
      cx.save();
      cx.translate(OX+lr*Math.cos(a),OY+lr*Math.sin(a));
      cx.rotate(a+Math.PI/2);
      cx.font="10px 'Source Sans 3'"; cx.textAlign='center'; cx.textBaseline='middle';
      cx.fillStyle='rgba(228,200,115,0.92)';
      cx.fillText(String(i).padStart(2,'0'),0,0);
      cx.restore();
    }
  }
}

// ── TIME HAND ───────────────────────────────────────────────────
function drawHand(now) {
  const s = now.getHours()*3600+now.getMinutes()*60+now.getSeconds()+now.getMilliseconds()/1000;
  const a = (s/86400)*TP-Math.PI/2;
  const len=R*.96, tx=OX+len*Math.cos(a), ty=OY+len*Math.sin(a);
  const hg=cx.createLinearGradient(OX,OY,tx,ty);
  hg.addColorStop(0,'rgba(7,15,9,0)');
  hg.addColorStop(.4,'rgba(200,230,200,0.15)');
  hg.addColorStop(.75,'rgba(200,230,200,0.55)');
  hg.addColorStop(1,'rgba(220,245,220,0.90)');
  cx.beginPath(); cx.moveTo(OX,OY); cx.lineTo(tx,ty);
  cx.strokeStyle=hg; cx.lineWidth=1.2; cx.stroke();
  const tg=cx.createRadialGradient(tx,ty,0,tx,ty,11);
  tg.addColorStop(0,'rgba(200,235,195,0.95)');
  tg.addColorStop(.35,'rgba(160,200,160,0.40)');
  tg.addColorStop(1,'transparent');
  cx.beginPath(); cx.arc(tx,ty,11,0,TP); cx.fillStyle=tg; cx.fill();
}

// ════════════════════════════════════════════════════════════════
// WAVE CANVAS
// ════════════════════════════════════════════════════════════════
const wc  = document.getElementById('wc');
const wct = wc.getContext('2d');

function drawWaveCanvas(now) {
  const PW = wc.parentElement.offsetWidth || 600;
  if(PW !== wc.width) wc.width = PW;
  const WW=wc.width, WH=72;
  wct.clearRect(0,0,WW,WH);
  wct.fillStyle='rgba(4,10,5,0.60)'; wct.fillRect(0,0,WW,WH);

  const nf=(now.getHours()*3600+now.getMinutes()*60+now.getSeconds())/86400;

  [{fn:Crt,rgb:'190,112,62',w:1},{fn:Tmp,rgb:'62,128,118',w:1},{fn:Mel,rgb:'142,110,158',w:1},{fn:F,rgb:'192,160,70',w:2}]
  .forEach(({fn,rgb,w})=>{
    wct.beginPath();
    for(let px=0;px<=WW;px++){
      const v=fn(px/WW*TAU), y=WH/2-v*WH*.28;
      px===0?wct.moveTo(px,y):wct.lineTo(px,y);
    }
    wct.strokeStyle=`rgba(${rgb},${w>1?.72:.42})`; wct.lineWidth=w; wct.stroke();
  });

  getTimes().forEach((tH,i)=>{
    const x=(tH/TAU)*WW;
    const {h,s,l}=CLR[i];
    wct.beginPath(); wct.moveTo(x,2); wct.lineTo(x,WH-2);
    wct.strokeStyle=hs(h,s,l,.20); wct.lineWidth=.7; wct.stroke();
    wct.fillStyle=hs(h,s,l,.28);
    wct.font="9px 'Source Sans 3'"; wct.textAlign='center';
    wct.fillText(i+1,x,WH-3);
  });

  wct.beginPath(); wct.moveTo(nf*WW,0); wct.lineTo(nf*WW,WH);
  wct.strokeStyle='rgba(198,172,105,0.35)'; wct.lineWidth=1;
  wct.setLineDash([2,4]); wct.stroke(); wct.setLineDash([]);
}

// ════════════════════════════════════════════════════════════════
// PHASE IDENTIFICATION
// ════════════════════════════════════════════════════════════════
function whichPhase(now, times) {
  const h = now.getHours()+now.getMinutes()/60+now.getSeconds()/3600;
  for(let i=0;i<9;i++){
    if(i<8){ if(h>=times[i]&&h<times[i+1]) return i; }
    else { if(h>=times[i]||h<times[0]) return i; }
  } return 0;
}

// ════════════════════════════════════════════════════════════════
// UI UPDATES
// ════════════════════════════════════════════════════════════════
function fmtT(t) {
  t = ((t % TAU) + TAU) % TAU;
  let hh = Math.floor(t) % 24;
  let mm = Math.round((t % 1) * 60);
  if(mm >= 60){ mm = 0; hh = (hh + 1) % 24; }
  return String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
}

function buildSidebar() {
  const sb = document.getElementById('sidebar-left');
  sb.innerHTML = '<div class="sidebar-label">Phases</div>';
  const times = getTimes();
  NAMES.forEach((nm,i)=>{
    const {h,s,l}=CLR[i];
    const btn = document.createElement('button');
    btn.className = 'ph-btn'; btn.id = 'phb-'+i;
    btn.innerHTML = `
      <div class="ph-pip" style="background:${hs(h,s,l)};box-shadow:0 0 5px ${hs(h,s,l,.38)}"></div>
      <div class="ph-info">
        <span class="ph-name">${nm}</span>
        <span class="ph-time">${fmtT(times[i])}</span>
      </div>`;
    btn.addEventListener('click', ()=>selectPhase(i));
    sb.appendChild(btn);
  });
}

function buildMobileStrip() {
  const strip = document.getElementById('phase-strip');
  if(!strip) return;
  strip.innerHTML = '';
  NAMES.forEach((nm,i)=>{
    const {h,s,l}=CLR[i];
    const d = document.createElement('div');
    d.className = 'ps-dot' + (i===lastPh?' active':'');
    d.id = 'ps-'+i;
    d.textContent = i+1;
    d.style.borderColor = i===lastPh ? hs(h,s,l,.50) : 'transparent';
    d.style.color = i===lastPh ? hs(h,s+5,l+5,.95) : hs(h,s,l,.38);
    d.style.background = 'rgba(5,14,7,0.50)';
    d.style.boxShadow  = i===lastPh ? `0 0 10px ${hs(h,s,l,.18)}` : 'none';
    d.title = nm;
    d.addEventListener('click', ()=>selectPhase(i));
    strip.appendChild(d);
  });
}

let forcedPhase = -1;
function selectPhase(i) {
  forcedPhase = i;
  document.getElementById('live-return').style.display = 'block';
  clearTimeout(window._ft);
  window._ft = setTimeout(()=>{ returnToLive(); }, 12000);
}
function returnToLive() {
  forcedPhase = -1;
  clearTimeout(window._ft);
  document.getElementById('live-return').style.display = 'none';
  lastPh = -1;
}

let lastPh = -1;

function minsUntil(nowH, targetH) {
  let diff = (targetH - nowH + TAU) % TAU;
  return Math.round(diff * 60);
}

function fmtDuration(mins) {
  if(mins < 60) return mins + ' min';
  const h = Math.floor(mins/60), m = mins%60;
  return m === 0 ? h + ' h' : h + ' h ' + m + ' min';
}

function updateActivePhase(ph) {
  if(ph===lastPh) return;
  lastPh = ph;
  const {h,s,l}=CLR[ph];
  const times=getTimes();

  for(let i=0;i<9;i++){
    const b=document.getElementById('phb-'+i);
    if(!b)continue;
    b.classList.toggle('active',i===ph);
    const pip=b.querySelector('.ph-pip');
    pip.style.boxShadow = i===ph
      ? `0 0 10px ${hs(CLR[i].h,CLR[i].s,CLR[i].l,.78)},0 0 20px ${hs(CLR[i].h,CLR[i].s,CLR[i].l,.32)}`
      : `0 0 5px ${hs(CLR[i].h,CLR[i].s,CLR[i].l,.35)}`;
    b.querySelector('.ph-time').textContent = fmtT(times[i]);
    const dot = document.getElementById('ps-'+i);
    if(dot) dot.classList.toggle('active',i===ph);
  }

  const nameEl = document.getElementById('ct-name');
  const bioEl  = document.getElementById('bio-text');
  nameEl.style.transition = 'opacity 0.5s ease';
  bioEl.style.transition  = 'opacity 0.5s ease';
  nameEl.style.opacity = '0';
  bioEl.style.opacity  = '0';

  const endPh    = (ph + 1) % 9;
  const startStr = fmtT(times[ph]);
  const endStr   = fmtT(times[endPh]);

  setTimeout(()=>{
    document.getElementById('ct-num').textContent    = `Phase ${ph+1} of 9`;
    nameEl.textContent     = NAMES[ph];
    nameEl.style.color     = hs(h,s+5,l+5);
    nameEl.style.textShadow = `0 0 20px ${hs(h,s,l,.22)}`;
    nameEl.style.opacity   = '1';
    document.getElementById('ct-range').textContent  = startStr + ' \u2013 ' + endStr;
    bioEl.textContent      = BIO[ph];
    bioEl.style.opacity    = '1';

    const lbl = document.getElementById('sr-phase-label');
    if(lbl) lbl.textContent = NAMES[ph];
    const srNext = document.getElementById('sr-next');
    if(srNext) srNext.textContent = endStr;
    refreshSidebarWake();

    const mpNum   = document.getElementById('tp-phase-num');
    const mpName  = document.getElementById('tp-phase-name');
    const mpRange = document.getElementById('tp-phase-range');
    const mpBio   = document.getElementById('tp-phase-bio');
    if(mpNum)   mpNum.textContent   = `Phase ${ph+1} of 9`;
    if(mpName)  { mpName.textContent = NAMES[ph]; mpName.style.color = hs(h,s+5,l+5); }
    if(mpRange) mpRange.textContent = startStr + ' \u2013 ' + endStr;
    if(mpBio)   mpBio.textContent   = BIO[ph];
  }, 450);
}

function refreshSidebarWake() {
  const srWake = document.getElementById('sr-wake');
  if(srWake) srWake.textContent = fmtT(wakeHour % TAU);
}

let _lastCountdownMin = -99;
function updateCountdown(now, force=false) {
  const nowH   = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;
  const curMin = now.getHours()*60 + now.getMinutes();
  if(!force && curMin === _lastCountdownMin) return;
  _lastCountdownMin = curMin;

  const times = getTimes();
  const ph    = lastPh >= 0 ? lastPh : 0;
  const endPh = (ph+1)%9;
  const mins  = minsUntil(nowH, times[endPh]);

  const until = document.getElementById('ct-until');
  if(until) until.textContent = fmtDuration(mins) + ' remaining';

  const srC = document.getElementById('sr-countdown');
  if(srC) srC.textContent = fmtDuration(mins);

  if(wakeTimestamp) {
    const diffMs = now - wakeTimestamp;
    const diffM  = Math.floor(diffMs / 60000);
    const wkSince = document.getElementById('wake-since');
    if(wkSince) wkSince.textContent = diffM < 60
      ? diffM + ' min ago'
      : Math.floor(diffM/60) + ' h ' + (diffM%60) + ' min ago';
  }
}

// ════════════════════════════════════════════════════════════════
// TAB SWITCHING
// ════════════════════════════════════════════════════════════════
document.querySelectorAll('.tb').forEach(b=>{
  b.addEventListener('click',()=>{
    const pane=b.dataset.pane;
    document.querySelectorAll('.tb').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.getElementById(pane).classList.add('on');
    requestAnimationFrame(()=>{ resize(); });
  });
});

// ════════════════════════════════════════════════════════════════
// WAKE TIME PICKER
// ════════════════════════════════════════════════════════════════
let pickerH = 6, pickerM = 30;

function openWakePicker() {
  const base = wakeTimestamp ? wakeHour : (new Date().getHours() + new Date().getMinutes()/60);
  pickerH = Math.floor(base) % 24;
  pickerM = Math.round((base % 1) * 60);
  if(pickerM >= 60){ pickerM = 0; pickerH = (pickerH+1)%24; }
  updatePickerDisplay();
  highlightPreset();
  document.getElementById('wake-overlay').classList.add('open');
}

function closeWakePicker() {
  document.getElementById('wake-overlay').classList.remove('open');
}

function updatePickerDisplay() {
  document.getElementById('wp-hr').textContent = String(pickerH).padStart(2,'0');
  document.getElementById('wp-mn').textContent = String(pickerM).padStart(2,'0');
  highlightPreset();
}

function highlightPreset() {
  document.querySelectorAll('.wp-preset').forEach(b => {
    const ph = parseInt(b.dataset.h), pm = parseInt(b.dataset.m);
    b.classList.toggle('selected', !isNaN(ph) && ph === pickerH && pm === pickerM);
    if(b.id === 'wp-now-preset') b.classList.remove('selected');
  });
}

function applyWakeTime() {
  wakeHour = pickerH + pickerM / 60;
  wakeTimestamp = new Date();
  wakeTimestamp.setHours(pickerH, pickerM, 0, 0);

  const newOff = Math.max(0, Math.min(3.0, wakeHour - 6.5));
  chronoOff = newOff;
  const slider = document.getElementById('csl');
  if(slider) slider.value = Math.round(newOff * 10);

  document.getElementById('wake-time-display').textContent = fmtT(wakeHour);

  const now = new Date();
  const diffM = Math.round((now - wakeTimestamp) / 60000);
  document.getElementById('wake-since').textContent =
    diffM <= 1 ? 'just now' :
    diffM < 60 ? diffM + ' min ago' :
    Math.floor(diffM/60) + ' h ' + (diffM%60) + ' min ago';

  refreshSidebarWake();
  updateChronoUI(chronoOff);
  buildSidebar();
  buildMobileStrip();
  // Reset trace canvas on wake time change (phases shift)
  initTraceCanvas();
  lastPh = -1;
  closeWakePicker();

  const btn = document.getElementById('wake-btn');
  btn.classList.add('pulsing');
  setTimeout(()=> btn.classList.remove('pulsing'), 1800);
}

document.getElementById('wake-btn').addEventListener('click', openWakePicker);

document.getElementById('wp-hr-up').addEventListener('click', ()=>{ pickerH=(pickerH+1)%24; updatePickerDisplay(); });
document.getElementById('wp-hr-dn').addEventListener('click', ()=>{ pickerH=(pickerH+23)%24; updatePickerDisplay(); });
document.getElementById('wp-mn-up').addEventListener('click', ()=>{
  pickerM+=5; if(pickerM>=60){ pickerM-=60; pickerH=(pickerH+1)%24; } updatePickerDisplay();
});
document.getElementById('wp-mn-dn').addEventListener('click', ()=>{
  pickerM-=5; if(pickerM<0){ pickerM+=60; pickerH=(pickerH+23)%24; } updatePickerDisplay();
});

document.querySelectorAll('.wp-preset[data-h]').forEach(b => {
  b.addEventListener('click', ()=>{
    pickerH = parseInt(b.dataset.h);
    pickerM = parseInt(b.dataset.m);
    updatePickerDisplay();
  });
});
document.getElementById('wp-now-preset').addEventListener('click', ()=>{
  const n = new Date();
  pickerH = n.getHours();
  pickerM = Math.round(n.getMinutes() / 5) * 5;
  if(pickerM >= 60){ pickerM = 0; pickerH=(pickerH+1)%24; }
  document.getElementById('wp-now-preset').classList.add('selected');
  updatePickerDisplay();
});

document.getElementById('wp-confirm').addEventListener('click', applyWakeTime);
document.getElementById('wp-cancel').addEventListener('click', closeWakePicker);
document.getElementById('wake-overlay').addEventListener('click', function(e){
  if(e.target === this) closeWakePicker();
});

// ════════════════════════════════════════════════════════════════
// CHRONOTYPE
// ════════════════════════════════════════════════════════════════
document.querySelectorAll('.cb').forEach(b=>{
  b.addEventListener('click',function(){
    document.querySelectorAll('.cb').forEach(x=>x.classList.remove('on'));
    this.classList.add('on');
    const v=parseInt(this.dataset.v);
    document.getElementById('csl').value=v;
    chronoOff=v/10;
    updateChronoUI(chronoOff);
    buildSidebar();
    buildMobileStrip();
    initTraceCanvas();
    lastPh=-1;
  });
});

document.getElementById('csl').addEventListener('input',function(){
  chronoOff=parseInt(this.value)/10;
  document.querySelectorAll('.cb').forEach(b=>b.classList.remove('on'));
  const v=parseInt(this.value);
  if(v<=3) document.querySelector('.cb[data-v="0"]').classList.add('on');
  else if(v<=20) document.querySelector('.cb[data-v="15"]').classList.add('on');
  else document.querySelector('.cb[data-v="30"]').classList.add('on');
  updateChronoUI(chronoOff);
  buildSidebar();
  buildMobileStrip();
  initTraceCanvas();
  lastPh=-1;
});

function updateChronoUI(v) {
  const lb = v < 0.8 ? 'Morning' : v < 2.2 ? 'Intermediate' : 'Evening';
  if(!wakeTimestamp) wakeHour = 6.5 + v;
  const wakeT = fmtT(wakeHour % TAU);
  document.getElementById('csl-val').textContent     = `+${v.toFixed(1)} h`;
  document.getElementById('chrono-lbl').textContent  = lb;
  document.getElementById('chrono-wake').textContent = `Wake \u2248 ${wakeT}`;
  refreshSidebarWake();
  if(!wakeTimestamp) {
    document.getElementById('wake-time-display').textContent = wakeT;
    document.getElementById('wake-since').textContent        = 'estimated';
  }
}

// ════════════════════════════════════════════════════════════════
// MAIN LOOP
// ════════════════════════════════════════════════════════════════
function frame(t) {
  const now    = new Date();
  const times  = getTimes();
  const livePh = whichPhase(now, times);
  const ph     = forcedPhase >= 0 ? forcedPhase : livePh;

  updateActivePhase(ph);

  const gb = 1 + Math.sin(t*.00125)*.028;

  drawBG(t);

  for(let i=spores.length-1;i>=0;i--){
    const p=spores[i]; p.x+=p.vx; p.y+=p.vy; p.vx*=.97; p.vy*=.97; p.life-=p.decay;
    if(p.life<=0){spores.splice(i,1);continue;}
    const rg=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.size*p.life);
    rg.addColorStop(0,hs(p.h,p.s,p.l+15,p.life*.55)); rg.addColorStop(1,'transparent');
    cx.beginPath(); cx.arc(p.x,p.y,p.size*p.life,0,TP); cx.fillStyle=rg; cx.fill();
  }

  for(let i=0;i<9;i++){
    const sT=times[i], eT=times[(i+1)%9];
    let sA=(sT/TAU)*TP-Math.PI/2, eA=(eT/TAU)*TP-Math.PI/2;
    if(i===8&&eA<=sA) eA+=TP; if(eA<=sA) eA+=TP;
    const ob=1+Math.sin(t*.00085+i*.72)*.012;
    const ab=i===ph?1+Math.sin(t*.0017)*.038:1;
    drawPetal(i,sA,eA,gb*ob*ab,t,i===ph);
  }

  drawCentre(ph,t);
  drawRing(t);
  drawHand(now);

  if(document.getElementById('tp-waves').classList.contains('on'))
    drawWaveCanvas(now);

  updateCountdown(now);

  document.getElementById('hdr-clock').textContent =
    now.toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById('hdr-date').textContent =
    now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});

  requestAnimationFrame(frame);
}

// ════════════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════════════
window.addEventListener('load', ()=>{
  buildSidebar();
  requestAnimationFrame(()=>{
    buildMobileStrip();
    if(window.innerWidth <= 900) {
      document.querySelectorAll('.tb').forEach(x=>x.classList.remove('on'));
      document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('on'));
      const pt = document.getElementById('tb-phase');
      if(pt) pt.classList.add('on');
      const pp = document.getElementById('tp-phase');
      if(pp) pp.classList.add('on');
    } else {
      document.querySelector('.tb[data-pane="tp-chrono"]').classList.add('on');
      document.getElementById('tp-chrono').classList.add('on');
    }
    resize();
    const now0   = new Date();
    const times0 = getTimes();
    const ph0    = whichPhase(now0, times0);
    updateActivePhase(ph0);
    updateChronoUI(0);
    updateCountdown(now0, true);
    requestAnimationFrame(frame);
    setTimeout(resize, 150);

    // ── ARTWORK FILE LOADER ──
    function showToast(msg, duration) {
      const t = document.getElementById('art-toast');
      if (!t) return;
      t.textContent = msg;
      t.style.display = 'block';
      if (duration) setTimeout(function() { t.style.display = 'none'; }, duration);
    }

    const artInput = document.getElementById('artwork-file');
    if (artInput) {
      artInput.addEventListener('change', function(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        showToast('Reading image\u2026');

        const reader = new FileReader();

        reader.onprogress = function(ev) {
          if (ev.lengthComputable) {
            const pct = Math.round(ev.loaded / ev.total * 100);
            showToast('Loading\u2026 ' + pct + '%');
          }
        };

        reader.onload = function(ev) {
          showToast('Decoding\u2026');
          setTimeout(function() {
            const img = new Image();
            img.onload = function() {
              mandalaImg    = img;
              mandalaLoaded = true;
              // Reset trace canvas when new artwork loads
              initTraceCanvas();
              showToast('\u2713 Artwork loaded', 3000);
              const wrap  = document.getElementById('artwork-upload-wrap');
              const lname = document.getElementById('artwork-loaded-name');
              const ltext = document.getElementById('artwork-label-text');
              if (wrap)  wrap.classList.add('loaded');
              if (lname) lname.textContent = file.name.length > 24 ? file.name.slice(0,22) + '\u2026' : file.name;
              if (ltext) ltext.textContent = '\u2713 artwork loaded';
              setTimeout(function() { if (wrap) wrap.style.display = 'none'; }, 4000);
            };
            img.onerror = function() {
              showToast('\u26A0 Image failed \u2014 try JPEG/PNG', 4000);
            };
            img.src = ev.target.result;
          }, 50);
        };

        reader.onerror = function() {
          showToast('\u26A0 Could not read file', 4000);
        };

        reader.readAsDataURL(file);
      });
    }
  });
});

// Keyboard support for wake picker
document.addEventListener('keydown', function(e) {
  if(!document.getElementById('wake-overlay').classList.contains('open')) return;
  if(e.key === 'Escape') { e.preventDefault(); closeWakePicker(); return; }
  if(e.key === 'Enter')  { e.preventDefault(); applyWakeTime(); return; }
  if(e.key === 'ArrowUp')   { e.preventDefault(); pickerM+=5; if(pickerM>=60){pickerM-=60;pickerH=(pickerH+1)%24;} updatePickerDisplay(); }
  if(e.key === 'ArrowDown') { e.preventDefault(); pickerM-=5; if(pickerM<0){pickerM+=60;pickerH=(pickerH+23)%24;} updatePickerDisplay(); }
  if(e.key === 'ArrowRight'){ e.preventDefault(); pickerH=(pickerH+1)%24; updatePickerDisplay(); }
  if(e.key === 'ArrowLeft') { e.preventDefault(); pickerH=(pickerH+23)%24; updatePickerDisplay(); }
});

</script>

<!-- ARTWORK UPLOAD (fixed bottom-centre, outside shell) -->
<div id="artwork-upload-wrap">
  <label id="artwork-label" for="artwork-file">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/>
      <line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
    <div>
      <div id="artwork-label-text">Load artwork</div>
      <div id="artwork-loaded-name">&mdash;</div>
    </div>
  </label>
  <input type="file" id="artwork-file" accept="image/*">
</div>

</body>
</html>
