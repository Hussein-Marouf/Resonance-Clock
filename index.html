<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Resonance Clock</title>
    <meta name="description" content="9-Phase circadian clock visualization" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500;600&family=DM+Sans:wght@300;400;500;600;700&family=Cinzel:wght@500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      html, body { height: 100%; margin: 0; background: #040810; }
      * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
      #root { min-height: 100vh; }

      ::-webkit-scrollbar { width: 3px; }
      ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 2px; }

      .su { animation: su .22s ease-out; }
      @keyframes su { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
      .fi { animation: fi .2s; }
      @keyframes fi { from { opacity: 0; } to { opacity: 1; } }

      button { cursor: pointer; }
      textarea { font-family: "DM Sans", sans-serif; color: white; }
    </style>
  </head>

  <body>
    <noscript>This app requires JavaScript.</noscript>
    <div id="root"></div>

    <!-- React (UMD) -->
    <!-- React docs show this pattern for adding React via CDN script tags. -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Recharts dependencies -->
    <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Recharts (UMD). Using 2.10.3 because it has an explicit /umd build. -->
    <script crossorigin src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <!-- Babel Standalone (compile JSX in-browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo, useCallback } = React;

      // Recharts globals from the UMD build
      const {
        AreaChart, Area,
        LineChart, Line,
        XAxis, YAxis,
        Tooltip, ResponsiveContainer,
        ReferenceLine
      } = Recharts;

      const PHASES = [
        {
          id: 1, name: "Rest", symbol: "ðŸŒ™", start: 0, end: 6.95,
          fill: "#1a1650", stroke: "#a5b4fc", glow: "#818cf8",
          desc: "Deep restoration & memory consolidation",
          science: "Educational model. Sleep architecture, slow-wave sleep, and glymphatic activity vary across individuals and environments.",
          best: ["Sleep", "Rest", "Meditation"], avoid: ["Stimulants", "Screens", "Heavy food"]
        },
        {
          id: 2, name: "Awakening", symbol: "ðŸŒ…", start: 6.95, end: 8.5,
          fill: "#6b2d00", stroke: "#fcd34d", glow: "#fbbf24",
          desc: "Cortisol Awakening Response activates the system",
          science: "Cortisol awakening response (CAR) occurs after waking; magnitude and timing differ by person. This is a visualization, not a diagnostic tool.",
          best: ["Planning", "Light exercise", "Journaling"], avoid: ["Caffeine (delay if desired)", "High-stakes decisions"]
        },
        {
          id: 3, name: "Focus Rise", symbol: "âš¡", start: 8.5, end: 10.0,
          fill: "#0d3d38", stroke: "#5eead4", glow: "#2dd4bf",
          desc: "Cognitive clarity builds",
          science: "Alertness and executive performance often improve after wake; variability is large (sleep debt, chronotype, light exposure).",
          best: ["Deep work", "Writing", "Analysis"], avoid: ["Multitasking", "Passive meetings"]
        },
        {
          id: 4, name: "Peak Focus", symbol: "ðŸŽ¯", start: 10.0, end: 12.5,
          fill: "#6b2200", stroke: "#fb923c", glow: "#f97316",
          desc: "Daily apex window",
          science: "Many people experience strong late-morning performance; others peak earlier/later depending on chronotype.",
          best: ["Complex decisions", "Learning", "Problem solving"], avoid: ["Interruptions", "Low-value tasks"]
        },
        {
          id: 5, name: "Integration", symbol: "ðŸ”—", start: 12.5, end: 14.5,
          fill: "#053d2f", stroke: "#34d399", glow: "#10b981",
          desc: "Consolidation & collaboration",
          science: "Post-lunch dip exists for many, but not all; itâ€™s influenced by sleep, meal composition, and circadian phase.",
          best: ["Meetings", "Collaboration", "Lunch"], avoid: ["Critical solo analysis", "Major decisions"]
        },
        {
          id: 6, name: "Creative", symbol: "ðŸŽ¨", start: 14.5, end: 16.5,
          fill: "#3b1580", stroke: "#c084fc", glow: "#a78bfa",
          desc: "Divergent thinking window",
          science: "Some evidence suggests creative tasks may benefit from different arousal states; not universal.",
          best: ["Brainstorming", "Art", "Lateral thinking"], avoid: ["Rigid analysis", "Detailed editing"]
        },
        {
          id: 7, name: "Vitality", symbol: "ðŸ”¥", start: 16.5, end: 18.5,
          fill: "#6b1010", stroke: "#f87171", glow: "#ef4444",
          desc: "Physical performance window",
          science: "Core body temperature and some performance metrics often peak late afternoon; individual timing varies.",
          best: ["Exercise", "Sport", "Physical work"], avoid: ["Demanding mental tasks"]
        },
        {
          id: 8, name: "Wind Down", symbol: "ðŸŒ†", start: 18.5, end: 21.0,
          fill: "#6b0f3a", stroke: "#f9a8d4", glow: "#ec4899",
          desc: "Parasympathetic shift",
          science: "Evening light exposure can shift circadian timing. This is informational, not medical advice.",
          best: ["Light social", "Cooking", "Reflection"], avoid: ["Intense exercise", "Bright light", "Doomscrolling"]
        },
        {
          id: 9, name: "Preparation", symbol: "ðŸŒŒ", start: 21.0, end: 24.0,
          fill: "#091235", stroke: "#93c5fd", glow: "#60a5fa",
          desc: "Sleep initiation window",
          science: "Melatonin onset varies widely; light, schedule, and genetics affect timing.",
          best: ["Reading", "Meditation", "Journaling"], avoid: ["Screens", "Caffeine", "Alcohol"]
        },
      ];

      const ACTIVITIES = [
        { name: "Deep Work",  icon: "ðŸ’¡", optimalPhases: [3,4] },
        { name: "Exercise",   icon: "ðŸ‹ï¸", optimalPhases: [7,2] },
        { name: "Creative",   icon: "ðŸŽ¨", optimalPhases: [6,3] },
        { name: "Meetings",   icon: "ðŸ‘¥", optimalPhases: [5,4] },
        { name: "Learning",   icon: "ðŸ“š", optimalPhases: [4,3] },
        { name: "Rest/Nap",   icon: "ðŸ˜´", optimalPhases: [1,9] },
        { name: "Social",     icon: "ðŸ¤", optimalPhases: [5,8] },
        { name: "Planning",   icon: "ðŸ“‹", optimalPhases: [2,4] },
        { name: "Meditation", icon: "ðŸ§˜", optimalPhases: [1,9] },
        { name: "Sport",      icon: "âš½", optimalPhases: [7,6] },
      ];

      // --- Hormone math (stylized cosine harmonics) ---
      function clamp(v) { return Math.max(0.02, Math.min(0.98, v)); }
      function cosH(n, t, p) { return Math.cos(2 * Math.PI * n * (t - p) / 24); }

      function cortisol(t) {
        return clamp(0.5 + 0.32*cosH(1,t,7.5) + 0.10*cosH(2,t,7.5) + 0.04*cosH(3,t,7.5) + 0.02*cosH(4,t,7.5));
      }
      function bodyTemp(t) {
        return clamp(0.5 + 0.28*cosH(1,t,17.0) + 0.07*cosH(2,t,17.0) + 0.02*cosH(3,t,17.0));
      }
      function melatonin(t) {
        return clamp(0.5 + 0.38*cosH(1,t,3.0) + 0.08*cosH(2,t,3.0) + 0.02*cosH(3,t,3.0));
      }
      function composite(t) {
        return 0.5*cortisol(t) + 0.3*bodyTemp(t) + 0.2*melatonin(t);
      }

      // --- Geometry helpers ---
      function hDeg(h) { return (h / 24) * 360; }
      function toXY(cx, cy, r, deg) {
        const rad = (deg - 90) * Math.PI / 180;
        return [cx + r*Math.cos(rad), cy + r*Math.sin(rad)];
      }
      function arcD(cx, cy, r1, r2, h1, h2) {
        const a1 = hDeg(h1);
        const a2 = hDeg(Math.min(h2, 23.9999));
        const [x1,y1] = toXY(cx, cy, r2, a1);
        const [x2,y2] = toXY(cx, cy, r2, a2);
        const [ix1,iy1] = toXY(cx, cy, r1, a2);
        const [ix2,iy2] = toXY(cx, cy, r1, a1);
        const lg = (a2 - a1) > 180 ? 1 : 0;
        return `M${x1},${y1} A${r2},${r2} 0 ${lg},1 ${x2},${y2} L${ix1},${iy1} A${r1},${r1} 0 ${lg},0 ${ix2},${iy2}Z`;
      }
      function wavePath(cx, cy, rMin, rMax, fn, n = 300) {
        let d = "";
        for (let i = 0; i <= n; i++) {
          const t = (i / n) * 24;
          const r = rMin + (rMax - rMin) * fn(t);
          const [x,y] = toXY(cx, cy, r, (i / n) * 360);
          d += (i === 0 ? "M" : "L") + x.toFixed(2) + "," + y.toFixed(2) + " ";
        }
        return d.trim() + " Z";
      }

      // Model-hour + wake-offset -> displayed clock time
      function fmtShifted(modelHour, offset) {
        const s = ((modelHour + offset) % 24 + 24) % 24;
        let hh = Math.floor(s);
        let mm = Math.round((s - hh) * 60);
        if (mm === 60) { mm = 0; hh = (hh + 1) % 24; }
        return `${hh}:${String(mm).padStart(2, "0")}`;
      }

      function phaseAt(sh) {
        for (const p of PHASES) {
          if (sh >= p.start && sh < p.end) return p;
        }
        return PHASES[0];
      }

      function ResonanceClock() {
        const [now, setNow] = useState(new Date());
        const [wakeHour, setWakeHour] = useState(7.0);
        const [tab, setTab] = useState("clock");
        const [selAct, setSelAct] = useState(null);
        const [trackLog, setTrackLog] = useState([]);
        const [modal, setModal] = useState(false);
        const [entry, setEntry] = useState({ energy: 3, focus: 3, mood: 3, note: "" });

        // Derived time
        const wo = wakeHour - 7.0; // wakeOffset relative to model wake=7.0
        const curHour = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;
        const shiftedH = ((curHour - wo) % 24 + 24) % 24;

        const curPhase = useMemo(() => phaseAt(shiftedH), [shiftedH]);

        const phaseProg = useMemo(() => {
          const denom = (curPhase.end - curPhase.start) || 1;
          return (shiftedH - curPhase.start) / denom;
        }, [shiftedH, curPhase]);

        useEffect(() => {
          const t = setInterval(() => setNow(new Date()), 1000);
          return () => clearInterval(t);
        }, []);

        // Load log (localStorage)
        useEffect(() => {
          try {
            const raw = localStorage.getItem("rc-log");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) setTrackLog(parsed);
          } catch (e) {}
        }, []);

        const saveLog = useCallback((l) => {
          try { localStorage.setItem("rc-log", JSON.stringify(l)); } catch (e) {}
        }, []);

        const addEntry = useCallback(() => {
          const e = {
            ...entry,
            time: now.toISOString(),
            hour: +curHour.toFixed(2),
            phase: curPhase.name,
            phaseId: curPhase.id
          };

          setTrackLog((prev) => {
            const nl = [e, ...prev].slice(0, 100);
            saveLog(nl);
            return nl;
          });

          setModal(false);
          setEntry({ energy: 3, focus: 3, mood: 3, note: "" });
        }, [entry, now, curHour, curPhase, saveLog]);

        // Alignment score (wrap 9â†”1)
        const alignScore = useCallback((act) => {
          const idx = act.optimalPhases.indexOf(curPhase.id);
          if (idx === 0) return 95;
          if (idx === 1) return 78;

          const N = 9;
          const d = Math.min(
            ...act.optimalPhases.map((id) => {
              const diff = Math.abs(id - curPhase.id);
              return Math.min(diff, N - diff);
            })
          );

          if (d === 1) return 60;
          if (d === 2) return 42;
          return 20;
        }, [curPhase]);

        const hormoneData = useMemo(() => {
          return Array.from({ length: 49 }, (_, i) => {
            const h = i / 2;
            return {
              hour: h,
              cortisol: +cortisol(h).toFixed(3),
              temp: +bodyTemp(h).toFixed(3),
              melatonin: +melatonin(h).toFixed(3),
              composite: +composite(h).toFixed(3),
            };
          });
        }, []);

        // SVG layout constants
        const CX = 220, CY = 220, SZ = 440;
        const R_TICK_IN = 198, R_TICK_OUT = 210, R_HLABEL = 224;
        const R_ARC_OUT = 194, R_ARC_IN = 150;
        const R_ARC_MID = (R_ARC_IN + R_ARC_OUT) / 2;
        const R_PROG = 148;
        const R_WAVE_OUT = 142, R_WAVE_IN = 106;
        const R_PETAL = 88, R_CENTER = 70;

        const needleDeg = hDeg(shiftedH);
        const [nTX, nTY] = toXY(CX, CY, R_ARC_OUT + 9, needleDeg);
        const [nBX, nBY] = toXY(CX, CY, 18, (needleDeg + 180) % 360);

        const progEndH = curPhase.start + (curPhase.end - curPhase.start) * phaseProg;
        const [pAX, pAY] = toXY(CX, CY, R_PROG, hDeg(curPhase.start));
        const [pBX, pBY] = toXY(CX, CY, R_PROG, hDeg(Math.min(progEndH, 23.9999)));
        const progLA = (hDeg(progEndH) - hDeg(curPhase.start)) > 180 ? 1 : 0;

        const timeStr = `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
        const secStr = String(now.getSeconds()).padStart(2,"0");

        return (
          <div style={{
            minHeight: "100vh",
            fontFamily: "'DM Sans', sans-serif",
            background: "#040810",
            maxWidth: 480,
            margin: "0 auto",
            color: "white",
            display: "flex",
            flexDirection: "column"
          }}>
            {/* HEADER */}
            <div style={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
              padding: "10px 14px",
              borderBottom: "1px solid rgba(255,255,255,0.07)"
            }}>
              <div>
                <div style={{
                  fontFamily: "Cinzel,serif",
                  fontSize: 14,
                  fontWeight: 700,
                  letterSpacing: "0.22em",
                  color: curPhase.glow
                }}>RESONANCE</div>
                <div style={{
                  fontSize: 10,
                  color: "rgba(255,255,255,0.3)",
                  letterSpacing: "0.04em"
                }}>9-Phase Circadian Clock Â· H.A. Marouf</div>
              </div>

              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)" }}>
                  {now.toLocaleDateString("en-US",{ weekday:"short", month:"short", day:"numeric" })}
                </div>
                <button
                  onClick={() => setModal(true)}
                  style={{
                    fontSize: 11,
                    padding: "5px 12px",
                    borderRadius: 20,
                    border: `1px solid ${curPhase.glow}50`,
                    color: curPhase.glow,
                    background: curPhase.glow + "14"
                  }}
                >+ Track</button>
              </div>
            </div>

            {/* TABS */}
            <div style={{ display: "flex", background: "rgba(0,0,0,0.5)", borderBottom: "1px solid rgba(255,255,255,0.06)" }}>
              {[
                ["clock","Clock"],
                ["align","Align"],
                ["insights","Insights"],
                ["science","Science"]
              ].map(([id, lb]) => (
                <button
                  key={id}
                  onClick={() => setTab(id)}
                  style={{
                    flex: 1,
                    padding: "10px 0",
                    fontSize: 11,
                    fontWeight: 500,
                    background: "transparent",
                    border: "none",
                    borderBottom: `2px solid ${tab===id ? curPhase.glow : "transparent"}`,
                    color: tab===id ? curPhase.glow : "rgba(255,255,255,0.35)",
                    transition: "color .2s,border-color .2s"
                  }}
                >
                  {lb}
                </button>
              ))}
            </div>

            <div style={{ flex: 1, overflowY: "auto", paddingBottom: 28 }}>

              {/* CLOCK TAB */}
              {tab === "clock" && (
                <div className="su">
                  <div style={{ padding: "6px 2px 0" }}>
                    <svg viewBox={`0 0 ${SZ} ${SZ}`} width="100%" style={{ display: "block" }}>
                      <defs>
                        <filter id="gw4"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                        <filter id="gw7"><feGaussianBlur stdDeviation="7" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                        <filter id="gw2"><feGaussianBlur stdDeviation="2.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>

                        {PHASES.map(p => (
                          <radialGradient key={`rg${p.id}`} id={`rg${p.id}`} cx="50%" cy="50%" r="50%">
                            <stop offset="0%" stopColor={p.stroke} stopOpacity="1"/>
                            <stop offset="55%" stopColor={p.fill} stopOpacity="1"/>
                            <stop offset="100%" stopColor={p.fill} stopOpacity="0.75"/>
                          </radialGradient>
                        ))}

                        <radialGradient id="centGr" cx="50%" cy="50%" r="50%">
                          <stop offset="0%" stopColor={curPhase.fill} stopOpacity="0.65"/>
                          <stop offset="100%" stopColor="#030608" stopOpacity="1"/>
                        </radialGradient>
                      </defs>

                      {/* Ambient glow */}
                      <circle cx={CX} cy={CY} r={R_ARC_OUT+24} fill="none" stroke={curPhase.glow} strokeWidth="48" strokeOpacity="0.032"/>

                      {/* Hour ticks */}
                      {Array.from({ length: 24 }, (_, i) => {
                        const a = hDeg(i), maj = i % 6 === 0, min3 = i % 3 === 0;
                        const [x1,y1] = toXY(CX,CY,R_TICK_IN,a);
                        const [x2,y2] = toXY(CX,CY,R_TICK_OUT + (maj ? 9 : min3 ? 5 : 2), a);
                        return (
                          <line
                            key={i}
                            x1={x1} y1={y1} x2={x2} y2={y2}
                            stroke={maj ? "rgba(255,255,255,0.8)" : min3 ? "rgba(255,255,255,0.38)" : "rgba(255,255,255,0.13)"}
                            strokeWidth={maj ? 1.8 : min3 ? 1 : 0.7}
                          />
                        );
                      })}

                      {/* Hour labels every 3h */}
                      {[0,3,6,9,12,15,18,21].map(h => {
                        const [lx,ly] = toXY(CX,CY,R_HLABEL,hDeg(h));
                        const label = (h===0) ? "12a" : (h===12) ? "12p" : (h>12) ? `${h}p` : `${h}a`;
                        return (
                          <text
                            key={h}
                            x={lx} y={ly}
                            textAnchor="middle"
                            dominantBaseline="middle"
                            fontSize="8.5"
                            fill="rgba(255,255,255,0.6)"
                            fontFamily="DM Mono,monospace"
                            fontWeight="500"
                          >{label}</text>
                        );
                      })}

                      {/* Phase arcs */}
                      {PHASES.map(p => {
                        const active = p.id === curPhase.id;
                        return (
                          <g key={`pa${p.id}`}>
                            <path
                              d={arcD(CX,CY,R_ARC_IN,R_ARC_OUT,p.start,p.end)}
                              fill={active ? `url(#rg${p.id})` : p.fill}
                              stroke={p.stroke}
                              strokeWidth={active ? 2 : 0.6}
                              opacity={active ? 1 : 0.72}
                              filter={active ? "url(#gw4)" : "none"}
                            />
                            {active && (
                              <>
                                <path d={arcD(CX,CY,R_ARC_OUT,R_ARC_OUT+6,p.start,p.end)} fill={p.stroke} fillOpacity="0.45" filter="url(#gw4)"/>
                                <path d={arcD(CX,CY,R_ARC_IN,R_ARC_IN+5,p.start,p.end)} fill={p.stroke} fillOpacity="0.22" filter="url(#gw2)"/>
                              </>
                            )}
                          </g>
                        );
                      })}

                      {/* Divider lines */}
                      {PHASES.map(p => {
                        const [x1,y1] = toXY(CX,CY,R_ARC_IN-3,hDeg(p.start));
                        const [x2,y2] = toXY(CX,CY,R_ARC_OUT+5,hDeg(p.start));
                        return <line key={`dv${p.id}`} x1={x1} y1={y1} x2={x2} y2={y2} stroke="#040810" strokeWidth="2.2"/>;
                      })}

                      {/* Phase labels */}
                      {PHASES.map(p => {
                        const mid = (p.start + p.end) / 2;
                        const [tx,ty] = toXY(CX,CY,R_ARC_MID,hDeg(mid));
                        const active = p.id === curPhase.id;
                        return (
                          <g key={`lbl${p.id}`}>
                            {active && <ellipse cx={tx} cy={ty} rx="13" ry="16" fill={p.stroke} fillOpacity="0.18"/>}
                            <text x={tx} y={ty-4} textAnchor="middle" dominantBaseline="middle" fontSize={active ? "15" : "12"} opacity={active ? 1 : 0.82}>
                              {p.symbol}
                            </text>
                            <text
                              x={tx} y={ty+10}
                              textAnchor="middle"
                              dominantBaseline="middle"
                              fontFamily="DM Mono,monospace"
                              fontWeight="600"
                              fontSize={active ? "9" : "8"}
                              fill={active ? "white" : p.stroke}
                              fillOpacity={active ? 1 : 0.7}
                            >{p.id}</text>
                          </g>
                        );
                      })}

                      {/* Progress track */}
                      <path d={arcD(CX,CY,R_PROG-2,R_PROG+2,curPhase.start,curPhase.end)} fill="rgba(255,255,255,0.05)"/>
                      {phaseProg > 0.015 && (
                        <path
                          d={`M${pAX},${pAY} A${R_PROG},${R_PROG} 0 ${progLA},1 ${pBX},${pBY}`}
                          fill="none"
                          stroke="white"
                          strokeWidth="3.5"
                          strokeLinecap="round"
                          strokeOpacity="0.88"
                          filter="url(#gw2)"
                        />
                      )}

                      {/* Ring separators */}
                      <circle cx={CX} cy={CY} r={R_ARC_IN} fill="none" stroke="rgba(255,255,255,0.18)" strokeWidth="1.2"/>
                      <circle cx={CX} cy={CY} r={R_WAVE_OUT+3} fill="none" stroke="rgba(255,255,255,0.09)" strokeWidth="0.8"/>
                      <circle cx={CX} cy={CY} r={R_WAVE_IN-3} fill="none" stroke="rgba(255,255,255,0.09)" strokeWidth="0.8"/>

                      {/* Hormone wave ring background */}
                      <path d={arcD(CX,CY,R_WAVE_IN,R_WAVE_OUT,0,24)} fill="#030609" fillOpacity="0.97"/>

                      {/* Hormone curves */}
                      <path d={wavePath(CX,CY,R_WAVE_IN+2,R_WAVE_OUT-2,cortisol)} fill="none" stroke="#fbbf24" strokeWidth="1.4" strokeOpacity="0.7"/>
                      <path d={wavePath(CX,CY,R_WAVE_IN+2,R_WAVE_OUT-2,bodyTemp)} fill="none" stroke="#f97316" strokeWidth="1.4" strokeOpacity="0.7"/>
                      <path d={wavePath(CX,CY,R_WAVE_IN+2,R_WAVE_OUT-2,melatonin)} fill="none" stroke="#818cf8" strokeWidth="1.4" strokeOpacity="0.7"/>
                      <path d={wavePath(CX,CY,R_WAVE_IN+2,R_WAVE_OUT-2,composite)} fill="none" stroke={curPhase.glow} strokeWidth="2.2" strokeOpacity="0.92"/>

                      {/* Mid baseline ring */}
                      <circle cx={CX} cy={CY} r={(R_WAVE_IN+R_WAVE_OUT)/2} fill="none" stroke="rgba(255,255,255,0.07)" strokeWidth="0.6" strokeDasharray="3,4"/>

                      {/* Legend dots */}
                      {[{l:"C",c:"#fbbf24",a:5},{l:"T",c:"#f97316",a:40},{l:"M",c:"#818cf8",a:75},{l:"F",c:curPhase.glow,a:110}].map(({l,c,a}) => {
                        const [lx,ly] = toXY(CX,CY,R_WAVE_IN-8,a);
                        return (
                          <g key={l}>
                            <circle cx={lx} cy={ly} r="5.5" fill={c} fillOpacity="0.92"/>
                            <text x={lx} y={ly} textAnchor="middle" dominantBaseline="middle" fontSize="5" fontWeight="700" fill="#020507" fontFamily="DM Mono,monospace">{l}</text>
                          </g>
                        );
                      })}

                      {/* 9-petal mandala */}
                      <circle cx={CX} cy={CY} r={R_WAVE_IN-4} fill="#040810"/>
                      {Array.from({length:9}, (_,i) => {
                        const angle = (i/9) * 360;
                        const ph = PHASES[i];
                        const active = ph.id === curPhase.id;
                        const [px,py] = toXY(CX,CY,R_PETAL,angle);
                        return (
                          <ellipse
                            key={`pt${i}`}
                            cx={px} cy={py}
                            rx="9" ry="17"
                            transform={`rotate(${angle},${px},${py})`}
                            fill={ph.glow}
                            fillOpacity={active ? 0.42 : 0.09}
                            stroke={ph.glow}
                            strokeWidth="0.7"
                            strokeOpacity={active ? 0.88 : 0.28}
                            filter={active ? "url(#gw2)" : "none"}
                          />
                        );
                      })}

                      {/* Center */}
                      <circle cx={CX} cy={CY} r={R_CENTER+9} fill="#040810"/>
                      <circle cx={CX} cy={CY} r={R_CENTER} fill="url(#centGr)"/>
                      <circle cx={CX} cy={CY} r={R_CENTER} fill="none" stroke={curPhase.stroke} strokeWidth="1.8" strokeOpacity="0.72"/>
                      <circle cx={CX} cy={CY} r={R_CENTER+6} fill="none" stroke={curPhase.glow} strokeWidth="0.6" strokeOpacity="0.2"/>

                      <text x={CX} y={CY-26} textAnchor="middle" fontSize="19">{curPhase.symbol}</text>
                      <text x={CX} y={CY-10} textAnchor="middle" fontSize="7.5" fontFamily="Cinzel,serif" fontWeight="600" fill={curPhase.stroke} letterSpacing="2.5">
                        {curPhase.name.toUpperCase()}
                      </text>
                      <text x={CX} y={CY+8} textAnchor="middle" fontSize="21" fontFamily="DM Mono,monospace" fontWeight="600" fill="white">
                        {timeStr}<tspan fontSize="10" fill="rgba(255,255,255,0.36)">.{secStr}</tspan>
                      </text>
                      <text x={CX} y={CY+24} textAnchor="middle" fontSize="7.5" fontFamily="DM Sans,sans-serif" fill="rgba(255,255,255,0.3)">
                        Phase {curPhase.id} of 9
                      </text>

                      <rect x={CX-26} y={CY+30} width="52" height="2.5" rx="1.5" fill="rgba(255,255,255,0.07)"/>
                      <rect x={CX-26} y={CY+30} width={52*Math.min(phaseProg,1)} height="2.5" rx="1.5" fill={curPhase.stroke} opacity="0.85"/>

                      {/* Needle */}
                      <line x1={nBX} y1={nBY} x2={nTX} y2={nTY} stroke="white" strokeWidth="2" strokeLinecap="round"
                        style={{ filter: "drop-shadow(0 0 6px rgba(255,255,255,0.85))" }} />
                      <circle cx={nTX} cy={nTY} r="3.5" fill="white" style={{ filter: "drop-shadow(0 0 5px white)" }}/>
                      <circle cx={CX} cy={CY} r="7.5" fill={curPhase.stroke} filter="url(#gw2)"/>
                      <circle cx={CX} cy={CY} r="4" fill="white"/>
                    </svg>
                  </div>

                  {/* Wake time */}
                  <div style={{ margin:"0 12px 10px", padding:"11px 14px", borderRadius:12, background:"rgba(0,0,0,0.45)", border:"1px solid rgba(255,255,255,0.08)" }}>
                    <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between" }}>
                      <div>
                        <div style={{ fontSize:12, fontWeight:600, color:"white" }}>Wake time</div>
                        <div style={{ fontSize:10, color:"rgba(255,255,255,0.3)" }}>Shifts all 9 phase boundaries</div>
                      </div>

                      <div style={{ display:"flex", alignItems:"center", gap:10 }}>
                        <button
                          onClick={() => setWakeHour(h => Math.max(4, +(h - 0.5).toFixed(1)))}
                          style={{ width:30, height:30, borderRadius:15, border:"1px solid rgba(255,255,255,0.15)", background:"rgba(255,255,255,0.06)", color:"white", fontSize:18 }}
                        >âˆ’</button>

                        <span style={{ fontSize:15, fontWeight:700, fontFamily:"DM Mono,monospace", width:54, textAlign:"center" }}>
                          {Math.floor(wakeHour)}:{String(Math.round((wakeHour % 1) * 60)).padStart(2,"0")}
                        </span>

                        <button
                          onClick={() => setWakeHour(h => Math.min(11, +(h + 0.5).toFixed(1)))}
                          style={{ width:30, height:30, borderRadius:15, border:"1px solid rgba(255,255,255,0.15)", background:"rgba(255,255,255,0.06)", color:"white", fontSize:18 }}
                        >+</button>
                      </div>
                    </div>
                  </div>

                  {/* Phase map */}
                  <div style={{ margin:"0 12px 10px" }}>
                    <p style={{ fontSize:9, color:"rgba(255,255,255,0.3)", letterSpacing:"0.12em", marginBottom:7, fontFamily:"DM Mono,monospace" }}>
                      PHASE REFERENCE MAP
                    </p>
                    <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:6 }}>
                      {PHASES.map(p => {
                        const active = p.id === curPhase.id;
                        return (
                          <div
                            key={p.id}
                            style={{
                              padding:"7px 8px",
                              borderRadius:9,
                              background: active ? (p.fill + "b0") : "rgba(255,255,255,0.04)",
                              border: `1px solid ${active ? (p.stroke + "75") : "rgba(255,255,255,0.08)"}`,
                              display:"flex",
                              alignItems:"center",
                              gap:6
                            }}
                          >
                            <div style={{ width:8, height:8, borderRadius:2, background:p.stroke, flexShrink:0 }}/>
                            <div style={{ flex:1, minWidth:0 }}>
                              <div style={{
                                fontSize:9.5,
                                fontFamily:"DM Mono,monospace",
                                fontWeight:500,
                                color: active ? p.stroke : "rgba(255,255,255,0.65)",
                                whiteSpace:"nowrap",
                                overflow:"hidden",
                                textOverflow:"ellipsis"
                              }}>{p.name}</div>
                              <div style={{ fontSize:8, color:"rgba(255,255,255,0.28)", marginTop:1 }}>
                                {fmtShifted(p.start, wo)}
                              </div>
                            </div>
                            <div style={{ fontSize:12 }}>{p.symbol}</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* Disclaimer */}
                  <div style={{ margin:"0 12px 14px", padding:"10px 12px", borderRadius:12, border:"1px solid rgba(255,255,255,0.08)", background:"rgba(0,0,0,0.35)" }}>
                    <div style={{ fontSize:11, color:"rgba(255,255,255,0.55)", lineHeight:1.5 }}>
                      This is an educational visualization and journaling aid. It is not a medical device and does not provide medical advice.
                    </div>
                  </div>

                </div>
              )}

              {/* ALIGN TAB */}
              {tab === "align" && (
                <div className="su" style={{ padding:12, display:"flex", flexDirection:"column", gap:12 }}>
                  <div style={{
                    borderRadius:12, padding:12, display:"flex", alignItems:"center", gap:12,
                    border:`1px solid ${curPhase.stroke}35`,
                    background:`linear-gradient(135deg,${curPhase.fill}55,rgba(0,0,0,0.5))`
                  }}>
                    <span style={{ fontSize:32 }}>{curPhase.symbol}</span>
                    <div>
                      <p style={{ fontFamily:"Cinzel,serif", fontSize:13, fontWeight:700, color:curPhase.stroke, margin:0 }}>{curPhase.name}</p>
                      <p style={{ fontSize:11, color:"rgba(255,255,255,0.5)", margin:"2px 0 0" }}>{curPhase.desc}</p>
                    </div>
                  </div>

                  <p style={{ fontSize:9, color:"rgba(255,255,255,0.35)", letterSpacing:"0.12em", margin:0, fontFamily:"DM Mono,monospace" }}>
                    SELECT ACTIVITY â€” SEE BIOLOGICAL ALIGNMENT
                  </p>

                  <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8 }}>
                    {ACTIVITIES.map(act => {
                      const score = alignScore(act);
                      const sel = selAct && selAct.name === act.name;
                      const col = score >= 80 ? "#10b981" : score >= 60 ? "#f59e0b" : "#ef4444";

                      return (
                        <button
                          key={act.name}
                          onClick={() => setSelAct(act)}
                          style={{
                            padding:12,
                            borderRadius:12,
                            textAlign:"left",
                            border:`1px solid ${sel ? (curPhase.stroke + "60") : "rgba(255,255,255,0.08)"}`,
                            background: sel ? (curPhase.glow + "18") : "rgba(0,0,0,0.4)"
                          }}
                        >
                          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
                            <span style={{ fontSize:22 }}>{act.icon}</span>
                            <span style={{ fontSize:12, fontWeight:700, fontFamily:"DM Mono,monospace", color:col }}>{score}%</span>
                          </div>

                          <p style={{ fontSize:12, fontWeight:600, color:"white", margin:"6px 0 5px" }}>{act.name}</p>

                          <div style={{ height:2.5, borderRadius:1.5, background:"rgba(255,255,255,0.07)" }}>
                            <div style={{ width:`${score}%`, height:"100%", borderRadius:1.5, background:col }} />
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* INSIGHTS TAB */}
              {tab === "insights" && (
                <div className="su" style={{ padding:12, display:"flex", flexDirection:"column", gap:14 }}>
                  <div>
                    <p style={{ fontSize:9, color:"rgba(255,255,255,0.35)", letterSpacing:"0.12em", marginBottom:7, fontFamily:"DM Mono,monospace" }}>
                      24H HORMONE MODEL (STYLIZED)
                    </p>

                    <div style={{ borderRadius:12, padding:12, border:"1px solid rgba(255,255,255,0.07)", background:"rgba(0,0,0,0.45)" }}>
                      <ResponsiveContainer width="100%" height={170}>
                        <AreaChart data={hormoneData} margin={{ top:5, right:8, bottom:5, left:-28 }}>
                          <defs>
                            {[
                              ["cg", "#fbbf24"],
                              ["tg", "#f97316"],
                              ["mg", "#818cf8"],
                              ["fg", curPhase.glow]
                            ].map(([id,c]) => (
                              <linearGradient key={id} id={id} x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor={c} stopOpacity="0.25" />
                                <stop offset="95%" stopColor={c} stopOpacity="0" />
                              </linearGradient>
                            ))}
                          </defs>

                          <XAxis
                            dataKey="hour"
                            tick={{ fill:"#374151", fontSize:8 }}
                            axisLine={false}
                            tickLine={false}
                            tickFormatter={(h) => (h % 6 === 0 ? (h===0 ? "12a" : h===12 ? "12p" : h<12 ? `${h}a` : `${h}p`) : "")}
                          />
                          <YAxis domain={[0,1]} tick={false} axisLine={false} />

                          <Tooltip
                            contentStyle={{ background:"#07101f", border:"1px solid #1e293b", borderRadius:8, fontSize:11 }}
                            formatter={(v,n) => [`${(v*100).toFixed(0)}%`, n]}
                            labelFormatter={(h) => `${Math.floor(h)}:${(h%1===0.5) ? "30" : "00"}`}
                          />

                          <ReferenceLine x={curHour} stroke="rgba(255,255,255,0.4)" strokeDasharray="3 2" strokeWidth={1.2} />

                          <Area type="monotone" dataKey="cortisol" name="Cortisol" stroke="#fbbf24" fill="url(#cg)" strokeWidth={1.5} dot={false}/>
                          <Area type="monotone" dataKey="temp" name="Body Temp" stroke="#f97316" fill="url(#tg)" strokeWidth={1.5} dot={false}/>
                          <Area type="monotone" dataKey="melatonin" name="Melatonin" stroke="#818cf8" fill="url(#mg)" strokeWidth={1.5} dot={false}/>
                          <Area type="monotone" dataKey="composite" name="F(t)" stroke={curPhase.glow} fill="none" strokeWidth={2.2} dot={false} strokeDasharray="5 2"/>
                        </AreaChart>
                      </ResponsiveContainer>

                      <div style={{ marginTop:8, display:"flex", justifyContent:"space-between", gap:8 }}>
                        <button onClick={() => setModal(true)} style={{ fontSize:11, padding:"8px 12px", borderRadius:10, border:`1px solid ${curPhase.stroke}45`, background:"transparent", color:curPhase.stroke }}>
                          Add log entry
                        </button>
                        <button onClick={() => { try { localStorage.removeItem("rc-log"); } catch(e) {} setTrackLog([]); }} style={{ fontSize:11, padding:"8px 12px", borderRadius:10, border:"1px solid rgba(255,255,255,0.15)", background:"transparent", color:"rgba(255,255,255,0.6)" }}>
                          Clear log
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Log list */}
                  <div style={{ borderRadius:12, padding:12, border:"1px solid rgba(255,255,255,0.07)", background:"rgba(0,0,0,0.35)" }}>
                    <p style={{ fontSize:9, color:"rgba(255,255,255,0.35)", letterSpacing:"0.12em", margin:"0 0 10px", fontFamily:"DM Mono,monospace" }}>
                      YOUR LOG (LOCAL)
                    </p>

                    {trackLog.length === 0 ? (
                      <div style={{ fontSize:12, color:"rgba(255,255,255,0.55)", lineHeight:1.6 }}>
                        No entries yet.
                      </div>
                    ) : (
                      <div style={{ display:"flex", flexDirection:"column", gap:6, maxHeight:280, overflowY:"auto" }}>
                        {trackLog.map((e,i) => {
                          const ep = PHASES.find(p => p.name === e.phase) || PHASES[0];
                          return (
                            <div key={i} style={{ display:"flex", alignItems:"center", gap:10, padding:"9px 10px", borderRadius:10, border:"1px solid rgba(255,255,255,0.06)", background:"rgba(0,0,0,0.3)" }}>
                              <span style={{ fontSize:18 }}>{ep.symbol}</span>
                              <div style={{ flex:1, minWidth:0 }}>
                                <div style={{ display:"flex", justifyContent:"space-between" }}>
                                  <span style={{ fontSize:11, fontWeight:600 }}>{e.phase}</span>
                                  <span style={{ fontSize:10, color:"rgba(255,255,255,0.3)", fontFamily:"DM Mono,monospace" }}>
                                    {new Date(e.time).toLocaleTimeString("en-US",{ hour:"2-digit", minute:"2-digit" })}
                                  </span>
                                </div>
                                {e.note && (
                                  <div style={{ fontSize:10, marginTop:3, color:"rgba(255,255,255,0.35)", whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis" }}>
                                    {e.note}
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* SCIENCE TAB */}
              {tab === "science" && (
                <div className="su" style={{ padding:12, display:"flex", flexDirection:"column", gap:12 }}>
                  <div style={{ borderRadius:14, padding:14, border:"1px solid rgba(255,255,255,0.08)", background:"rgba(0,0,0,0.45)" }}>
                    <p style={{ fontSize:12, color:"rgba(255,255,255,0.65)", lineHeight:1.65, margin:0 }}>
                      This project is a visualization of a simplified circadian-style model. If you want it to be scientifically stronger:
                      (1) cite the parameter sources precisely, (2) expose calibration controls, and (3) validate against your own longitudinal measurements.
                    </p>
                  </div>
                </div>
              )}

            </div>

            {/* MODAL */}
            {modal && (
              <div
                className="fi"
                onClick={(e) => { if (e.target === e.currentTarget) setModal(false); }}
                style={{
                  position:"fixed", inset:0, zIndex:50,
                  display:"flex", alignItems:"flex-end", justifyContent:"center",
                  background:"rgba(0,0,0,0.82)", backdropFilter:"blur(12px)"
                }}
              >
                <div
                  className="su"
                  style={{
                    width:"100%", maxWidth:480,
                    borderRadius:"20px 20px 0 0",
                    padding:20,
                    background:"linear-gradient(180deg,#0c1828,#050a12)",
                    border:"1px solid rgba(255,255,255,0.1)",
                    borderBottom:"none"
                  }}
                >
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16 }}>
                    <div>
                      <h3 style={{ fontFamily:"Cinzel,serif", fontSize:15, fontWeight:700, margin:0 }}>Track Your State</h3>
                      <p style={{ fontSize:11, color:"rgba(255,255,255,0.4)", margin:"3px 0 0" }}>
                        {curPhase.symbol} {curPhase.name} Â· {timeStr}
                      </p>
                    </div>
                    <button
                      onClick={() => setModal(false)}
                      style={{ width:30, height:30, borderRadius:15, border:"1px solid rgba(255,255,255,0.15)", background:"rgba(255,255,255,0.07)", color:"rgba(255,255,255,0.6)", fontSize:14 }}
                    >âœ•</button>
                  </div>

                  {[
                    { k:"energy", l:"Energy Level", c:"#f59e0b" },
                    { k:"focus",  l:"Mental Focus", c:"#2dd4bf" },
                    { k:"mood",   l:"Mood / Wellbeing", c:"#a78bfa" },
                  ].map(({k,l,c}) => (
                    <div key={k} style={{ marginBottom:14 }}>
                      <div style={{ display:"flex", justifyContent:"space-between", marginBottom:7 }}>
                        <span style={{ fontSize:12, color:"rgba(255,255,255,0.7)" }}>{l}</span>
                        <span style={{ fontSize:12, fontWeight:700, color:c, fontFamily:"DM Mono,monospace" }}>{entry[k]}/5</span>
                      </div>
                      <div style={{ display:"flex", gap:6 }}>
                        {[1,2,3,4,5].map(v => (
                          <button
                            key={v}
                            onClick={() => setEntry(e => ({ ...e, [k]: v }))}
                            style={{
                              flex:1,
                              padding:"9px 0",
                              borderRadius:8,
                              fontSize:13,
                              fontWeight:700,
                              background: entry[k] >= v ? (c + "28") : "rgba(255,255,255,0.05)",
                              color: entry[k] >= v ? c : "rgba(255,255,255,0.2)",
                              border: entry[k] === v ? `1.5px solid ${c}` : "1.5px solid transparent"
                            }}
                          >{v}</button>
                        ))}
                      </div>
                    </div>
                  ))}

                  <textarea
                    placeholder="Optional noteâ€¦"
                    value={entry.note}
                    onChange={(e) => setEntry(s => ({ ...s, note: e.target.value }))}
                    rows={2}
                    style={{
                      width:"100%",
                      borderRadius:10,
                      padding:"10px 12px",
                      fontSize:12,
                      background:"rgba(0,0,0,0.55)",
                      border:"1px solid rgba(255,255,255,0.1)",
                      resize:"none",
                      outline:"none",
                      display:"block"
                    }}
                  />

                  <button
                    onClick={addEntry}
                    style={{
                      width:"100%",
                      marginTop:12,
                      padding:"13px 0",
                      borderRadius:12,
                      fontSize:13,
                      fontWeight:700,
                      background: curPhase.stroke,
                      color:"#020507",
                      border:"none",
                      letterSpacing:"0.06em"
                    }}
                  >SAVE ENTRY</button>
                </div>
              </div>
            )}
          </div>
        );
      }

      // Mount app
      const rootEl = document.getElementById("root");
      if (ReactDOM.createRoot) {
        ReactDOM.createRoot(rootEl).render(<ResonanceClock />);
      } else {
        ReactDOM.render(<ResonanceClock />, rootEl);
      }
    </script>
  </body>
</html>
